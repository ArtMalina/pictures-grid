{"version":3,"sources":["interfaces/cells.ts","components/Button.tsx","containers/Header/index.ts","containers/Header/Header.tsx","contexts/ServiceContext.ts","components/Canvas.tsx","AppConfig.ts","helpers/canvasMath.ts","components/CellsGrid.tsx","containers/CellsLayout/CellsLayout.tsx","containers/Cart/CartModal.tsx","containers/CellsLayout/index.ts","components/Input.tsx","components/Modal.tsx","services/testDbConfig.ts","services/interfaces.ts","services/mappers.ts","services/TestDataService.ts","App.tsx","index.tsx"],"names":["MyCanvasMouseEvents","MyModes","CartEvents","Button","props","title","event$","toggle","noActive","light","small","color","action","group","noBraces","fullWidth","textAlign","onClickHandler","useCallback","event","stopPropagation","preventDefault","next","type","Close","payload","modifiersTxt","filter","Boolean","map","t","push","className","join","onClick","children","Header","selectedCells$","filterBtn$","useMemo","Subject","useState","togglesState","setToggles","togglesStateRef","useRef","cells","setCells","useEffect","sub","subscribe","ev","console","log","current","ShowOwn","myState","allState","ShowOther","unsubscribe","style","backgroundColor","padding","width","Open","Modify","length","Context","React","createContext","Component","height","canvas2dCtxInList$","Click","onMouseMove","Move","setCanvasElement","el","getValue","ctx","getContext","id","onMouseLeave","ref","appConfig","inRowCells","cellsAmount","cellWidth","cellHeight","cellBorderWidth","maxCanvasWidth","getPointByCellNumber","cellNumber","y","Math","floor","BorderColors","getMin","index","arr","reduce","memo","getMax","COLORS","CellEventTypes","getPointByArea","tiledWidth","tiledHeight","offx","offy","offw","offh","drawCellsGrid","ctx2d","canvasSize","dy","dx","Array","from","forEach","_empty","i","offsetX","ddx","ddy","cellData","x","w","h","beginPath","fillStyle","random","rect","fill","lineWidth","strokeStyle","BASE","stroke","font","fillText","toString","round","drawCell","point","drawCellHovering","_canvasSize","borderWidth","borderColor","pointX","pointY","px","py","drawBoundedTilesImage","image","boundedCellsCoords","left","top","right","bottom","getCropPoint","getRealPoint","cropX","cropY","cropW","cropH","realX","realY","realW","realH","ofstX","ofstY","drawImage","CellsGrid","cellW","cellH","amount","ctx2dInList","displaying","displayCells","clearing","clearCells","tilesForDisplay","displayTiles","highlightCells","clearTiles","clearedCellNumberMap","displayedMap","displayHoverSelectedCells","tileCell","tile","url","img","Image","onload","boundedTiles","src","drawTileCell","isDisplayedOneLst","mouseType","SHOW_FILTERED_TILES","SELECTED","HOVERED","HOVER_SELECTED","CartOpenTypes","MAP_CURR_CELL_EV_TO_CELL_GRID_EV","_i","_arr","curr","CellsLayout","cellSize","cellsUpdate$","currentAcc$","modeRef","Buy","dataService","useContext","ServiceContext","sizeWithOuter","setSize","boxRef","cellsLayoutSizeRef","rowsDataRef","filteredCellsRef","cellTileUpdatesRef","BehaviorSubject","canvasMouseEvent$","cellsGridEvent$","shadeCells","contractTiles$","onBoxRef","finalCellWidth","rectWidth","inRow","finalWidth","rows","ceil","finalHeight","getState","val","cellEvents","updatesRef","cellEventOfIndex","acc","contractTilesData","isUpdateNeeds","displayingUpdatedTiles","tileCells","tileData","lastUpdate","version","UpdateByContract","highlights","Edit","owner","getAccount","None","evType","DisplayAll","DisplayOwnCells","unhighlightCells","notHighlightedSelected","findIndex","Remove","afterRemoveCellEvents","elem","clientX","clientY","currentTarget","offsetLeft","offsetTop","scrollLeft","scrollTop","selectedCellEvents","ft","coordX","coordY","inRowCount","deltaX","deltaY","getCellByClick","newCellData","find","MODE","CURRENT_ADDR","contractTiles","CLICK_TO_NEW_CELL","ADD_NEW_MOVE_CELL","EDIT_NOT_MINE_TILE_OE_EMPTY","result","display","clear","finalCellEvents","lastCell","ct","Canvas","Input","value","state","setState","onChangeHandler","onChange","disabled","Modal","open","groupUrl","includes","ifNewCell","token","BTN_TITLE","EV_NAME","Save","marginLeft","CartModal","modalEvent$","remove$","cartEvent$","tilesState","setTilesState","tilesRef","groupAvatarUrl","input$","inputDataRef","key","launcherSub","ModifyCellsMode","BuyCellsMode","params","inputData","SaveTiles","RemoveItems","marginBottom","price","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","EMPTY_ADDR","fromContractTile","ERROR_TOKEN","_id","tileToFirebaseMapper","item","idPart","tokenId","tileFirebaseMapper","Number","split","tokenFirebaseMapper","tokenToFirebaseMapper","DataService","_account","_state","_firebaseApp","_db","_tilesCollection","_tokensCollection","this","initializeApp","testFirebaseConfig","getFirestore","collection","Promise","resolve","setTimeout","a","getDoc","doc","data","ids","all","fetchTokenInfo","getDocs","tilesSnapshot","tokesSnapshot","tiles","docs","tokens","Date","getTime","contractTile","formTileData","sortedTiles","sort","b","updContractTilePart","tokensPromises","updateDoc","ifParentBounds","k","ifInGroupTileBounds","fetchTiles","currAcc","tData","snapShots","storedTiles","parentTilesTupleIds","parenTileId","buyingTileId","reject","query","where","parentStoredTilesSnapshot","parentStoredTilesForUpd","updatedTile","addDoc","undefined","App","TestDataService","cellEvent$","selectedCellsRef","cartState$","connect","then","isOk","catch","err","evArr","selected","newCells","evCells","DATA_SERVICE_STATE","myAccount","groupTiles","buyTiles","mintTiles","UserUpdateTileGroup","Provider","ReactDOM","render","document","getElementById"],"mappings":"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","file":"static/js/main.2d6bcc5d.chunk.js","sourcesContent":["import { ContractTileInfo, ContractTokenInfo } from \"../services/interfaces\";\r\n\r\nexport type TileCoords = [number, number];\r\n\r\nexport enum MyCanvasMouseEvents {\r\n    None = -1,\r\n    Move = 0,\r\n    Click = 1\r\n}\r\n\r\nexport enum MyModes {\r\n    None = '<none>',\r\n    Buy = '<buy-cell>',\r\n    Edit = '<edit-cell>',\r\n}\r\n\r\nexport interface ICellData {\r\n    cellNumber: number;\r\n    point: TileCoords;\r\n}\r\n\r\nexport type ICellEventData = {\r\n    lastCell: ICellData;\r\n    curr: ICellData;\r\n    mouseType: MyCanvasMouseEvents;\r\n    // contractTile?: ContractTileInfo;\r\n    // lastUpdate?: number;\r\n};\r\n\r\nexport enum CartEvents {\r\n    None = 'None',\r\n    Open = 'Open',\r\n    Close = 'Close',\r\n    Save = 'Save',\r\n    Buy = 'Buy',\r\n    RemoveItems = 'RemoveItems',\r\n    Modify = 'Modify',\r\n    ShowOwn = 'ShowOwn',\r\n    ShowOther = 'ShowOther',\r\n    SaveTiles = 'SaveTiles',\r\n}\r\n\r\ntype CartEventsOfCell =\r\n    | CartEvents.Close\r\n    | CartEvents.None\r\n    | CartEvents.Open\r\n    | CartEvents.ShowOther\r\n    | CartEvents.ShowOwn;\r\n\r\ntype CellsEventCart = {\r\n    payload: ICellEventData[];\r\n    type: CartEventsOfCell;\r\n    status?: any;\r\n};\r\n\r\ntype TileData = {\r\n    tile: ContractTileInfo;\r\n    token: ContractTokenInfo;\r\n}\r\n\r\nexport type ITileState = ICellData & TileData;\r\n\r\nexport type IUnmintedTileState = ICellData & Partial<TileData>;\r\n\r\nexport type TilesEventCart = {\r\n    payload: IUnmintedTileState[];\r\n    params?: Partial<ContractTileInfo>;\r\n    type:\r\n    | CartEvents.Close\r\n    | CartEvents.None\r\n    | CartEvents.Save\r\n    | CartEvents.Open\r\n    | CartEvents.Modify\r\n    | CartEvents.SaveTiles\r\n    | CartEvents.Buy\r\n    | CartEvents.RemoveItems;\r\n    status?: any;\r\n    groupUrl: string;\r\n};\r\n\r\nexport type ICartEventData = CellsEventCart | TilesEventCart;\r\n","import React, { PropsWithChildren, useCallback, useRef, useState } from 'react';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\nimport { CartEvents, ICartEventData } from '../interfaces/cells';\r\n\r\n\r\nexport interface IButtonProps<T = any> {\r\n    title?: string;\r\n    action?: T;\r\n    noActive?: boolean;\r\n    toggle?: undefined | 1 | 2;\r\n    group?: number;\r\n    light?: boolean;\r\n    noBraces?: boolean;\r\n    fullWidth?: boolean;\r\n    textAlign?: 'left' | 'center' | 'right';\r\n    small?: boolean;\r\n    color?: 'header' | 'base' | 'active' | 'primary' | 'secondary' | 'info' | 'error' | 'close';\r\n    event$?: Subject<ICartEventData | T>;\r\n}\r\n\r\nconst Button = (props: PropsWithChildren<IButtonProps>) => {\r\n    const { title, event$, toggle, noActive, light, small, color, action, group, noBraces, fullWidth, textAlign } = props;\r\n    const onClickHandler = useCallback((event: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n        event$ && event$.next(action ? { ...action, group } : { type: CartEvents.Close, payload: [] });\r\n    }, [event$, action, group]);\r\n\r\n    const modifiersTxt = [fullWidth && 'full-width', textAlign && `align-${textAlign}`, noActive && 'no-action', light && 'light', small && 'small', color].filter(Boolean).map(t => `btn--${t}`);\r\n    if (toggle === 1) modifiersTxt.push('btn--untoggled');\r\n    if (toggle === 2) modifiersTxt.push('btn--toggled');\r\n    if (group) modifiersTxt.push('btn--grouped');\r\n    return (\r\n        <div className={ ['btn', ...modifiersTxt].join(' ') } onClick={ onClickHandler }>\r\n            { !noBraces && <div className=\"btn_border btn_border--left\"></div> }\r\n            { !!title && <div className=\"btn-text\">{ title || '' }</div> }\r\n            { props.children }\r\n            { !noBraces && <div className=\"btn_border btn_border--right\"></div> }\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Button;","import Header from './Header';\r\n\r\nexport default Header;","import React, { useEffect, useMemo, useRef, useState } from 'react';\r\nimport { BehaviorSubject, Subject } from 'rxjs';\r\nimport Button from '../../components/Button';\r\nimport { CartEvents, ICartEventData, ICellData } from '../../interfaces/cells';\r\n\r\n\r\nexport interface IHeaderProps {\r\n    event$: Subject<ICartEventData>;\r\n    selectedCells$: BehaviorSubject<ICellData[]>;\r\n}\r\n\r\nconst Header = (props: IHeaderProps) => {\r\n    const { event$, selectedCells$ } = props;\r\n    const filterBtn$ = useMemo(() => new Subject<ICartEventData & { group?: number, status?: number }>(), []);\r\n    const [togglesState, setToggles] = useState<[2 | 1, 2 | 1]>([1, 2]);\r\n    const togglesStateRef = useRef(togglesState);\r\n    const [cells, setCells] = useState<ICellData[]>([]);\r\n    useEffect(() => {\r\n        const sub = filterBtn$.subscribe((ev) => {\r\n            console.log('%c filterBtn ev: ', 'background-color: brown; color: white;', ev);\r\n            console.log('downEv togglesStateRef.current', togglesStateRef.current);\r\n            if (ev.type === CartEvents.ShowOwn) {\r\n                if (ev.group) {\r\n                    const [myState, allState] = togglesStateRef.current;\r\n                    togglesStateRef.current = [myState === 1 ? 2 : 1, allState === 1 ? 2 : 1];\r\n                    setToggles(togglesStateRef.current);\r\n                }\r\n                return event$.next({\r\n                    type: togglesStateRef.current[0] === 1 ? CartEvents.ShowOther : CartEvents.ShowOwn,\r\n                    payload: ev.payload\r\n                });\r\n            }\r\n            event$.next(ev);\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [filterBtn$, event$, togglesStateRef]);\r\n\r\n    useEffect(() => {\r\n        const sub = selectedCells$.subscribe((cells) => {\r\n            console.log('%c selectedCells ev: ', 'background-color: brown; color: white;', cells);\r\n            setCells([...cells]);\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [selectedCells$]);\r\n\r\n\r\n    return <header>\r\n        <div className=\"header_content\">\r\n            <div className=\"flex-cnt align-center mx-4\">\r\n                <Button light color=\"header\" title=\"Hello, crypto man\" />\r\n            </div>\r\n            <div style={ { backgroundColor: 'white', padding: '0 10px' } }>\r\n            </div>\r\n            <div className=\"flex-cnt align-center\">\r\n                <div className=\"flex-cnt item fb-3\">\r\n                    <Button light small color=\"primary\" title=\"TILES\" event$={ filterBtn$ }\r\n                        action={ { type: CartEvents.ShowOwn, payload: [] } } group={ 1 }>\r\n                        <Button\r\n                            event$={ filterBtn$ }\r\n                            action={ { type: CartEvents.ShowOwn, payload: [] } }\r\n                            light\r\n                            small\r\n                            noBraces\r\n                            group={ 1 }\r\n                            toggle={ togglesState[0] }\r\n                            color=\"primary\"\r\n                            title=\"MY\"\r\n                        />\r\n                        <Button\r\n                            event$={ filterBtn$ }\r\n                            action={ { type: CartEvents.ShowOwn, payload: [] } }\r\n                            light\r\n                            small\r\n                            noBraces\r\n                            group={ 2 }\r\n                            toggle={ togglesState[1] }\r\n                            color=\"primary\"\r\n                            title=\"FOR SALE\"\r\n                        />\r\n                    </Button>\r\n                </div>\r\n                <div className=\"flex-cnt justify-end\" style={ { width: 250 } }>\r\n                    <div className=\"flex-cnt item shrink mx-3\">\r\n                        <Button\r\n                            event$={ event$ }\r\n                            action={ { type: togglesState[0] === 1 ? CartEvents.Open : CartEvents.Modify, payload: [] } }\r\n                            light\r\n                            color=\"info\"\r\n                            title={ togglesState[0] === 1 ? \"Buy\" : \"Modify\" }\r\n                        />\r\n                    </div>\r\n                    <div className=\"flex-cnt item shrink badge-cnt\">\r\n                        { !!cells.length && <div className=\"badge badge--info\">{ togglesState[0] === 1 ? '!' : cells.length }</div> }\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        {/* 'header' | 'base' | 'active' | 'primary' | 'secondary' | 'info' | 'error' | 'close' */ }\r\n        {/* <div className=\"flex-cnt align-center item wrap fb-6\">\r\n            <Button light color=\"header\" title=\"header\" />\r\n            <Button light color=\"base\" title=\"base\" />\r\n            <Button light color=\"active\" title=\"active\" />\r\n            <Button light color=\"primary\" title=\"primary\" />\r\n            <Button light color=\"secondary\" title=\"secondary\" />\r\n            <Button light color=\"info\" title=\"info\" />\r\n            <Button light color=\"error\" title=\"error\" />\r\n            <Button light color=\"close\" title=\"close\" />\r\n            <div className=\"flex-cnt justify-end align-center item\" style={ { backgroundColor: 'white' } }>\r\n                <Button color=\"header\" title=\"header\" />\r\n                <Button color=\"base\" title=\"base\" />\r\n                <Button color=\"active\" title=\"active\" />\r\n                <Button color=\"primary\" title=\"primary\" />\r\n                <Button color=\"secondary\" title=\"secondary\" />\r\n                <Button color=\"info\" title=\"info\" />\r\n                <Button color=\"error\" title=\"error\" />\r\n                <Button color=\"close\" title=\"close\" />\r\n            </div>\r\n        </div> */}\r\n    </header>;\r\n};\r\n\r\nexport default Header;\r\n","import React from \"react\";\r\nimport { IDataService } from \"../services/interfaces\";\r\n\r\nconst Context = React.createContext<IDataService | null>(null);\r\n\r\nexport default Context;","import React, { useCallback } from 'react';\r\nimport { BehaviorSubject, Subject } from 'rxjs';\r\nimport { MyCanvasMouseEvents } from '../interfaces/cells';\r\n\r\n\r\nexport interface ICanvasProps {\r\n    width: number;\r\n    height: number;\r\n    canvas2dCtxInList$: BehaviorSubject<CanvasRenderingContext2D[]>;\r\n    event$: Subject<[MyCanvasMouseEvents, React.MouseEvent<HTMLCanvasElement, MouseEvent>]>;\r\n}\r\n\r\nconst Component = (props: ICanvasProps) => {\r\n    const { width, height, event$, canvas2dCtxInList$ } = props;\r\n    const onClick = useCallback((event: React.MouseEvent<HTMLCanvasElement, MouseEvent>) => {\r\n        event$.next([MyCanvasMouseEvents.Click, event]);\r\n    }, [event$]);\r\n    const onMouseMove = useCallback((event: React.MouseEvent<HTMLCanvasElement, MouseEvent>) => {\r\n        event$.next([MyCanvasMouseEvents.Move, event]);\r\n    }, [event$]);\r\n\r\n    const setCanvasElement = useCallback((el: HTMLCanvasElement | null) => {\r\n        if (el && !canvas2dCtxInList$.getValue().length) {\r\n            const ctx = el.getContext('2d');\r\n            if (ctx) canvas2dCtxInList$.next([ctx]);\r\n        }\r\n    }, [canvas2dCtxInList$]);\r\n\r\n    return (\r\n        <div id=\"canvas-container\" style={ { width, height } }>\r\n            <canvas\r\n                id=\"canvas\"\r\n                onClick={ onClick }\r\n                onMouseMove={ onMouseMove }\r\n                onMouseLeave={ onMouseMove }\r\n                width={ width }\r\n                height={ height }\r\n                ref={ setCanvasElement }>\r\n            </canvas>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Component;","export interface IAppConfig {\r\n    cellsAmount: number;\r\n    inRowCells: number;\r\n    cellWidth: number;\r\n    cellHeight: number;\r\n    cellBorderWidth: number;\r\n    maxCanvasWidth: number;\r\n}\r\n\r\nexport const appConfig: IAppConfig = {\r\n    inRowCells: 0,\r\n    cellsAmount: 500,\r\n    cellWidth: 50,\r\n    cellHeight: 50,\r\n    cellBorderWidth: 2,\r\n    maxCanvasWidth: 1350,\r\n}\r\nappConfig.inRowCells = Math.floor((appConfig.maxCanvasWidth - appConfig.cellBorderWidth) / (appConfig.cellWidth + appConfig.cellBorderWidth));\r\n","import { appConfig } from '../AppConfig';\r\nimport { TileCoords } from '../interfaces/cells';\r\n\r\n/**\r\n * \r\n * @param cellNumber starts from ZERO\r\n * @returns \r\n */\r\nexport function getPointByCellNumber(cellNumber: number): [number, number] {\r\n    const y = Math.floor(cellNumber / appConfig.inRowCells);\r\n    const x = cellNumber - appConfig.inRowCells * y;\r\n    return [x, y];\r\n}\r\n\r\nexport function getCellByClick(coordX: number, coordY: number, { inRowCount, cellW, cellH }: { inRowCount: number, cellW: number, cellH: number }) {\r\n    const deltaX = Math.floor(coordX / cellW);\r\n    const deltaY = Math.floor(coordY / cellH);\r\n    return { cellNumber: deltaY * inRowCount + deltaX, x: deltaX, y: deltaY, w: cellW, h: cellH };\r\n}\r\n\r\nconst getMin = (index: 0 | 1, arr: TileCoords[]) => arr.reduce<TileCoords>((memo, t) => (!memo[0] && !memo[1]) || memo[index] > t[index] ? [t[0], t[1]] : memo, [0, 0]);\r\nconst getMax = (index: 0 | 1, arr: TileCoords[]) => arr.reduce<TileCoords>((memo, t) => (!memo[0] && !memo[1]) || memo[index] < t[index] ? [t[0], t[1]] : memo, [0, 0]);\r\n\r\nexport const getBoundTilesCorners = (arr: TileCoords[]) => {\r\n\r\n    const left = getMin(0, arr);\r\n    const top = getMin(1, arr);\r\n\r\n    const right = getMax(0, arr);\r\n    const bottom = getMax(1, arr);\r\n\r\n    return { left, top, right, bottom };\r\n\r\n}","import { useEffect } from 'react';\r\nimport { BehaviorSubject } from 'rxjs/internal/BehaviorSubject';\r\nimport { getBoundTilesCorners, getPointByCellNumber } from '../helpers/canvasMath';\r\nimport { IEventProps } from '../helpers/IEventProps';\r\nimport { ICellData, ITileState, MyCanvasMouseEvents, TileCoords } from '../interfaces/cells';\r\n\r\n\r\nexport interface ICellsGridEvent extends ICellData {\r\n    mouseType: MyCanvasMouseEvents;\r\n}\r\n\r\nexport type CellsGridEventData = {\r\n    displayCells: ICellsGridEvent[],\r\n    clearCells: ICellsGridEvent[],\r\n    displayTiles: ITileState[],\r\n    clearTiles: ITileState[],\r\n    highlightCells: ICellsGridEvent[],\r\n    shadeCells: ICellsGridEvent[],\r\n};\r\n\r\nexport interface ICellsGridProps extends IEventProps<CellsGridEventData> {\r\n    cellW: number;\r\n    cellH: number;\r\n    cellBorderWidth: number;\r\n    canvasSize: [number, number];\r\n    amount: number;\r\n    canvas2dCtxInList$: BehaviorSubject<CanvasRenderingContext2D[]>;\r\n}\r\n\r\nconst COLORS = ['#212529', '#23272c', '#22262b', '#23282e', '#25292e'];\r\n\r\n// const BORDER_COLOR = '#000000';\r\n// // const BORDER_COLOR = '#accaef';\r\n// const BORDER_HOVER_COLOR = 'yellow';\r\n// const BORDER_SELECTED_COLOR = 'orange';\r\n\r\nenum BorderColors {\r\n    BASE = '#000000',\r\n    HOVERED = 'yellow',\r\n    SELECTED = 'orange',\r\n    HOVER_SELECTED = '#69f0ae',\r\n    SHOW_FILTERED_TILES = 'silver'\r\n    // HOVER_SELECTED = '#00e5ff'\r\n    // HOVER_SELECTED = '#e64a19'\r\n    // HOVER_SELECTED = '#76ff03'\r\n\r\n}\r\n\r\nconst getPointByArea = (tiledWidth: number, tiledHeight: number, offx = 0, offy = 0, offw = 0, offh = 0) =>\r\n    (t: [number, number, number, number]) => [t[0] * tiledWidth + offx, t[1] * tiledHeight + offy, t[2] * tiledWidth - offw, t[3] * tiledHeight - offh];\r\n\r\n\r\nconst drawCell = (ctx2d: CanvasRenderingContext2D, [x, y, w, h]: [number, number, number, number], cellBorderWidth: number, cellData: ICellData) => {\r\n\r\n    ctx2d.beginPath();\r\n\r\n    // const r = 'rgb(38, 70, 83)'\r\n    // const r = 40 - Math.round(4 * Math.random());\r\n    // const g = 74 - Math.round(7 * Math.random());\r\n    // const b = 87 - Math.round(8 * Math.random());\r\n    // const r = 'rgb(61, 64, 91)'\r\n    // const r = 64 - Math.round(6 * Math.random());\r\n    // const g = 67 - Math.round(7 * Math.random());\r\n    // const b = 95 - Math.round(9 * Math.random());\r\n    // const r = 'rgb(0, 48, 73)'\r\n    // const r = 0;\r\n    // const g = 51 - Math.round(5 * Math.random());\r\n    // const b = 77 - Math.round(7 * Math.random());\r\n\r\n    ctx2d.fillStyle = COLORS[Math.floor(5 * Math.random())];\r\n    ctx2d.rect(x, y, w + cellBorderWidth, h + cellBorderWidth);\r\n    ctx2d.fill();\r\n\r\n    ctx2d.lineWidth = cellBorderWidth;\r\n    ctx2d.strokeStyle = BorderColors.BASE;\r\n    ctx2d.stroke();\r\n\r\n    ctx2d.font = \"italic 12pt Arial\";\r\n    ctx2d.fillStyle = '#4fc3f7';\r\n    ctx2d.fillText(`${cellData.cellNumber.toString()}`, Math.round(x + w * 0.1), Math.round(y + h * 0.5 - 5));\r\n};\r\n\r\nconst drawCellsGrid = (\r\n    ctx2d: CanvasRenderingContext2D,\r\n    canvasSize: [number, number],\r\n    cellsAmount: number,\r\n    cellWidth: number,\r\n    cellHeight: number,\r\n    cellBorderWidth: number\r\n) => {\r\n\r\n    const [width] = canvasSize;\r\n\r\n    let dy: number = cellBorderWidth * 0.5;\r\n    let dx: number = cellBorderWidth * 0.5;\r\n\r\n    Array.from(new Array(cellsAmount)).forEach((_empty: any, i: number) => {\r\n\r\n        let offsetX = cellBorderWidth;\r\n        let offsetY = cellBorderWidth;\r\n\r\n        if (dx + cellWidth > width) {\r\n\r\n            dx = cellBorderWidth * 0.5;\r\n            dy += cellHeight + offsetY;\r\n        }\r\n\r\n        ((i, ddx, ddy) => drawCell(\r\n            ctx2d,\r\n            [ddx, ddy, cellWidth, cellHeight],\r\n            cellBorderWidth,\r\n            { cellNumber: i + 1, point: [-1, -1] }\r\n        ))(i, dx, dy);\r\n\r\n        dx += cellWidth + offsetX;\r\n    });\r\n};\r\n\r\n// TODO: use via hoc maybe\r\nconst drawCellHovering = (\r\n    ctx2d: CanvasRenderingContext2D,\r\n    { point: [pointX, pointY] }: ICellData,\r\n    _canvasSize: [number, number],\r\n    [w, h]: [number, number],\r\n    borderWidth: number,\r\n    borderColor: BorderColors\r\n) => {\r\n\r\n    const px = borderWidth * 0.5 + (w + borderWidth) * pointX;\r\n    const py = borderWidth * 0.5 + (h + borderWidth) * pointY;\r\n\r\n    ctx2d.beginPath();\r\n\r\n    ctx2d.rect(px, py, w + borderWidth, h + borderWidth);\r\n\r\n    ctx2d.lineWidth = borderWidth;\r\n    ctx2d.strokeStyle = borderColor;\r\n    ctx2d.stroke();\r\n};\r\n\r\nconst drawTileCell = (ctx2d: CanvasRenderingContext2D, tileCell: ITileState, _canvasSize: [number, number], [w, h]: [number, number], borderWidth: number) => {\r\n    const [pointX, pointY] = tileCell.point;\r\n\r\n    const x = borderWidth + (w + borderWidth) * pointX;\r\n    const y = borderWidth + (h + borderWidth) * pointY;\r\n\r\n    ctx2d.beginPath();\r\n\r\n    ctx2d.fillStyle = '#37474f';\r\n    ctx2d.rect(x, y, w, h);\r\n    ctx2d.fill();\r\n\r\n    if (!tileCell.tile.url) return;\r\n\r\n    const img = new Image();\r\n    img.onload = () => {\r\n\r\n\r\n        if (tileCell.tile.boundedTiles.length && tileCell.tile.boundedTiles[0] === tileCell.tile.id) {\r\n            drawBoundedTilesImage(ctx2d, img, tileCell.tile.boundedTiles.map(t => getPointByCellNumber(t)), [w, h], borderWidth);\r\n            return;\r\n        }\r\n        // const natW = img.naturalWidth;\r\n        // const natH = img.naturalHeight;\r\n        // ctx.drawImage(img, 0, 0, natW, natH, x, y, w, h);\r\n        ctx2d.beginPath();\r\n        ctx2d.rect(x, y, w, h);\r\n        ctx2d.fillStyle = '#37474f';\r\n        ctx2d.fill();\r\n        ctx2d.drawImage(img, x, y, w, h);\r\n    };\r\n    img.src = tileCell.tile.url;\r\n\r\n};\r\n\r\nconst drawBoundedTilesImage = (\r\n    ctx2d: CanvasRenderingContext2D,\r\n    image: HTMLImageElement,\r\n    boundedCellsCoords: TileCoords[],\r\n    [w, h]: [number, number],\r\n    borderWidth: number\r\n) => {\r\n\r\n    const { left, right, bottom, top } = getBoundTilesCorners(boundedCellsCoords);\r\n\r\n    const [dx, dy] = [right[0] - left[0] + 1, bottom[1] - top[1] + 1];\r\n\r\n    const getCropPoint = getPointByArea(\r\n        image.width / dx,\r\n        image.height / dy,\r\n        -left[0] * image.width / dx,\r\n        -top[1] * image.height / dy,\r\n        1 / dx,\r\n        1 / dy\r\n    );\r\n    const getRealPoint = getPointByArea(w, h, 1, 1, 0, 0);\r\n\r\n    boundedCellsCoords.forEach(t => {\r\n        const [cropX, cropY, cropW, cropH] = getCropPoint([t[0], t[1], 1, 1]);\r\n        const [realX, realY, realW, realH] = getRealPoint([t[0], t[1], 1, 1]);\r\n        const ofstX = borderWidth * 0.5 + borderWidth * t[0];\r\n        const ofstY = borderWidth * 0.5 + borderWidth * t[1];\r\n        ctx2d.drawImage(\r\n            image,\r\n            cropX, cropY,\r\n            cropW, cropH,\r\n            realX + ofstX, realY + ofstY,\r\n            realW, realH\r\n        );\r\n    });\r\n\r\n};\r\n\r\nconst CellsGrid = (props: ICellsGridProps) => {\r\n\r\n    const { cellW, cellH, cellBorderWidth, amount, canvas2dCtxInList$, event$, canvasSize } = props;\r\n\r\n    useEffect(() => {\r\n        console.log('%c render cells Grid! ', 'border: 1px solid orange;', canvasSize);\r\n        const sub = canvas2dCtxInList$.subscribe((ctx2dInList) => {\r\n            ctx2dInList.forEach(ctx2d => {\r\n                drawCellsGrid(ctx2d, canvasSize, amount, cellW, cellH, cellBorderWidth);\r\n            });\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [cellW, cellH, cellBorderWidth, amount, canvasSize, canvas2dCtxInList$]);\r\n\r\n    useEffect(() => {\r\n        const sub = event$.subscribe((ev) => {\r\n            const {\r\n                displayCells: displaying,\r\n                clearCells: clearing,\r\n                displayTiles: tilesForDisplay,\r\n                clearTiles: tilesForClear,\r\n                highlightCells,\r\n            } = ev;\r\n            canvas2dCtxInList$.getValue().forEach(ctx2d => {\r\n\r\n                let clearedCellNumberMap: any = {};\r\n                let displayedMap: any = {};\r\n                const displayHoverSelectedCells: ICellsGridEvent[] = [];\r\n\r\n                tilesForDisplay.forEach(tileCell => {\r\n                    drawTileCell(ctx2d, tileCell, canvasSize, [cellW, cellH], cellBorderWidth);\r\n                });\r\n\r\n                clearing.forEach(({ cellNumber, point }) => {\r\n                    const isDisplayedOneLst = displaying.filter((t) => t.mouseType === MyCanvasMouseEvents.Click && t.cellNumber === cellNumber);\r\n                    // clear previous position!\r\n                    clearedCellNumberMap[cellNumber] = 1;\r\n                    if (!isDisplayedOneLst.length) {\r\n                        drawCellHovering(ctx2d, { cellNumber, point }, canvasSize, [cellW, cellH], cellBorderWidth, BorderColors.BASE);\r\n                    }\r\n                });\r\n                highlightCells.forEach(({ cellNumber, point }) => {\r\n                    drawCellHovering(ctx2d, { cellNumber, point }, canvasSize, [cellW, cellH], cellBorderWidth, BorderColors.SHOW_FILTERED_TILES);\r\n                });\r\n                displaying.forEach((t) => {\r\n                    const { cellNumber, mouseType, point } = t;\r\n                    // and then draw new hover position\r\n                    let color = mouseType === MyCanvasMouseEvents.Click ? BorderColors.SELECTED : BorderColors.HOVERED;\r\n                    if (displayedMap[cellNumber]) {\r\n                        // color = BorderColors.HOVER_SELECTED;\r\n                        displayHoverSelectedCells.push(t);\r\n                    } else {\r\n                        drawCellHovering(ctx2d, { cellNumber, point }, canvasSize, [cellW, cellH], cellBorderWidth, color);\r\n                    }\r\n                    if (mouseType === MyCanvasMouseEvents.Click) displayedMap[cellNumber] = 2;\r\n                    if (mouseType === MyCanvasMouseEvents.Move) displayedMap[cellNumber] = 1;\r\n                });\r\n                displayHoverSelectedCells.forEach(({ cellNumber, point }) => {\r\n                    drawCellHovering(ctx2d, { cellNumber, point }, canvasSize, [cellW, cellH], cellBorderWidth, BorderColors.HOVER_SELECTED);\r\n                });\r\n            });\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [event$, canvas2dCtxInList$, cellW, cellH, cellBorderWidth, canvasSize]);\r\n\r\n    return null;\r\n};\r\n\r\nexport default CellsGrid;","import React, { useCallback, useContext, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { BehaviorSubject } from 'rxjs/internal/BehaviorSubject';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\n\r\nimport ServiceContext from '../../contexts/ServiceContext';\r\n\r\nimport CanvasComponent from '../../components/Canvas';\r\n\r\nimport CellsGrid, { CellsGridEventData, ICellsGridEvent } from '../../components/CellsGrid';\r\nimport { getCellByClick } from '../../helpers/canvasMath';\r\nimport { IEventProps } from '../../helpers/IEventProps';\r\nimport { ICellData, ICellEventData, ITileState, MyCanvasMouseEvents, MyModes } from '../../interfaces/cells';\r\nimport { AccountAddr, EMPTY_ADDR, IDataService } from '../../services/interfaces';\r\n\r\n\r\nexport enum CellEventTypes {\r\n    None = 0,\r\n    Add = 1,\r\n    Remove = 2,\r\n    UpdateByContract = 3,\r\n    DisplayOwnCells = 4,\r\n    DisplayOtherCells = 5,\r\n    DisplayAll = 6,\r\n    UserUpdateTileGroup = 7\r\n}\r\n\r\nexport type NoneEvent = [CellEventTypes.None, ICellEventData[]];\r\nexport type AddTileEvent = [CellEventTypes.Add, ICellEventData[]];\r\nexport type RemoveTileInModifyModeEvent = [CellEventTypes.Remove, ITileState[]];\r\nexport type UpdateByContractEvent = [CellEventTypes.UpdateByContract, ICellEventData[]];\r\nexport type DisplayCellsEvent = [CellEventTypes.DisplayOwnCells, ICellEventData[]];\r\nexport type DisplayOtherEvent = [CellEventTypes.DisplayOtherCells, ICellEventData[]];\r\nexport type DisplayAllEvent = [CellEventTypes.DisplayAll, ICellEventData[]];\r\nexport type UserTilesSaveEvent = [CellEventTypes.UserUpdateTileGroup, ITileState[]];\r\n\r\nexport type CellsEvent =\r\n    | NoneEvent\r\n    | AddTileEvent\r\n    | RemoveTileInModifyModeEvent\r\n    | UpdateByContractEvent\r\n    | DisplayCellsEvent\r\n    | DisplayOtherEvent\r\n    | DisplayAllEvent\r\n    | UserTilesSaveEvent;\r\n\r\nexport interface ICellsLayoutProps extends IEventProps<ICellEventData[]> {\r\n    cellsUpdate$: Subject<CellsEvent>;\r\n    currentAcc$: BehaviorSubject<AccountAddr>;\r\n    cellsAmount: number;\r\n    cellSize: [number, number];\r\n    cellBorderWidth: number;\r\n    maxCanvasWidth: number;\r\n}\r\n\r\n\r\nconst MAP_CURR_CELL_EV_TO_CELL_GRID_EV = (t: ICellEventData, _i: number, _arr: ICellEventData[]): ICellsGridEvent => ({\r\n    cellNumber: t.curr.cellNumber,\r\n    point: t.curr.point,\r\n    mouseType: t.mouseType\r\n})\r\n\r\nconst Component = (props: ICellsLayoutProps) => {\r\n\r\n    const { cellSize, cellsAmount, cellBorderWidth, maxCanvasWidth, event$, cellsUpdate$, currentAcc$ } = props;\r\n\r\n    // TODO: MODE from props\r\n    const modeRef = useRef<MyModes>(MyModes.Buy);\r\n\r\n    // // TODO: currentAcc from props\r\n    // const currentAcc$ = useMemo(() => new BehaviorSubject<AccountAddr>('<test-account>' as AccountAddr), []);\r\n\r\n\r\n    const dataService = useContext(ServiceContext) as IDataService;\r\n\r\n    const [cellWidth, cellHeight] = cellSize;\r\n\r\n    const [sizeWithOuter, setSize] = useState<[number, number, boolean]>([0, 0, false]);\r\n    const boxRef = useRef<HTMLDivElement | null>(null);\r\n    const cellsLayoutSizeRef = useRef<[number, number]>([0, 0]);\r\n    const rowsDataRef = useRef<[number, number]>([0, 0]);\r\n\r\n    const filteredCellsRef = useRef<ICellsGridEvent[]>([]);\r\n\r\n    const cellTileUpdatesRef = useRef<{ [cellNumber: number]: number }>({});\r\n\r\n    const canvas2dCtxInList$ = useMemo(() => new BehaviorSubject<CanvasRenderingContext2D[]>([]), []);\r\n    const canvasMouseEvent$ = useMemo(() => new Subject<[MyCanvasMouseEvents, React.MouseEvent<HTMLCanvasElement, MouseEvent>]>(), []);\r\n\r\n\r\n    // [cells display] [cells clear] [tiles display] [tiles clear]\r\n    const cellsGridEvent$ = useMemo(() => new BehaviorSubject<CellsGridEventData>({\r\n        displayCells: [],\r\n        clearCells: [],\r\n        displayTiles: [],\r\n        clearTiles: [],\r\n        highlightCells: [],\r\n        shadeCells: []\r\n    }), []);\r\n\r\n    const contractTiles$ = useMemo(() => new BehaviorSubject<{ [id: number]: [number, ITileState] }>({}), []);\r\n\r\n    const [error, setError] = useState<[boolean, string | null]>([false, null]);\r\n\r\n    const onBoxRef = useCallback((el: HTMLDivElement | null) => {\r\n        if (el) {\r\n            const finalCellWidth = cellWidth;\r\n            const rectWidth = maxCanvasWidth;\r\n            // const rectWidth = width <= maxCanvasWidth ? width : maxCanvasWidth;\r\n            let inRow = Math.floor((rectWidth - cellBorderWidth) / (finalCellWidth + cellBorderWidth));\r\n            const finalWidth = (inRow + 1) * cellBorderWidth + inRow * finalCellWidth;\r\n            const rows = Math.ceil(cellsAmount / inRow);\r\n            const finalHeight = rows * cellHeight + rows * cellBorderWidth + cellBorderWidth;\r\n            boxRef.current = el;\r\n            rowsDataRef.current = [inRow, rows];\r\n            cellsLayoutSizeRef.current = [finalWidth, finalHeight];\r\n            setSize([\r\n                finalWidth,\r\n                finalHeight,\r\n                true,\r\n            ]);\r\n        }\r\n    }, [boxRef, cellsLayoutSizeRef, rowsDataRef, cellsAmount, cellBorderWidth, maxCanvasWidth, cellWidth, cellHeight]);\r\n\r\n    // useEffect(() => {\r\n    //     const sub = mode$.subscribe(mode => {\r\n    //     });\r\n    //     return () => sub.unsubscribe();\r\n    // }, [mode$]);\r\n\r\n    useEffect(() => {\r\n        // TODO: create async funcs outside, add it with mapping (like react-connect)\r\n        // 1. connect\r\n        // 2. start timer (5s asking smart-contract)\r\n        // 3. every count: get items (tiles)\r\n        // 4. compare items from service with items of state\r\n        // 5. new\\updated items display!\r\n        const sub = dataService.getState().subscribe(val => {\r\n            console.log('new state', { ...val });\r\n\r\n            const cellEvents = event$.getValue();\r\n\r\n            const updatesRef = cellTileUpdatesRef.current;\r\n            // TODO: too complex\r\n            const cellEventOfIndex = cellEvents.reduce((acc, t, i) => ({ ...acc, [t.curr.cellNumber]: i }), {} as { [id: number]: number });\r\n            const contractTilesData: { [id: number]: [number, ITileState]; } = {};\r\n            let isUpdateNeeds = false;\r\n\r\n            const displayingUpdatedTiles: ITileState[] = [];\r\n\r\n            val.tileCells.forEach(tileData => {\r\n                // new \\ updated Tile\r\n                contractTilesData[tileData.cellNumber] = [val.lastUpdate, { ...tileData }];\r\n                if (!updatesRef[tileData.cellNumber] || updatesRef[tileData.cellNumber] < tileData.tile.version + 1) {\r\n                    console.log('tile', tileData, cellEventOfIndex, [...cellEvents]);\r\n                    console.log('contractTilesData:cellNumber', tileData.cellNumber, tileData.tile.version, contractTilesData[tileData.cellNumber]);\r\n                    updatesRef[tileData.cellNumber] = tileData.tile.version + 1;\r\n                    displayingUpdatedTiles.push({ ...tileData });\r\n                    if (cellEventOfIndex[tileData.cellNumber] > 0) {\r\n                        // cellEventsRef[cellEventOfIndex[tile.cellNumber]].contractTile = { ...tile.tile };\r\n                        isUpdateNeeds = true;\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (isUpdateNeeds) {\r\n                cellsUpdate$.next([CellEventTypes.UpdateByContract, [...cellEvents]]);\r\n            }\r\n\r\n            // TODO: use [ Map<CellNumber, ITileState>, ITileState[] ] as [ aTilesMap, tilesForUpdate ]\r\n            contractTiles$.next({ ...contractTilesData });\r\n\r\n            // const cellEvents = event$.getValue().map<ICellEventData>(t => {\r\n            //     // const tile = val.tileCells\r\n            // });\r\n\r\n            let highlights: ICellsGridEvent[] = [];\r\n\r\n            if (modeRef.current === MyModes.Edit) {\r\n                highlights = val.tileCells\r\n                    .filter(t => t.tile && t.tile.owner === dataService.getAccount())\r\n                    .map<ICellsGridEvent>(t => ({\r\n                        cellNumber: t.cellNumber,\r\n                        mouseType: MyCanvasMouseEvents.None,\r\n                        point: t.point\r\n                    }));\r\n\r\n                filteredCellsRef.current = [...highlights];\r\n            }\r\n\r\n            // display updated tiles\r\n            cellsGridEvent$.next({\r\n                displayCells: [],\r\n                clearCells: [],\r\n                displayTiles: [...displayingUpdatedTiles],\r\n                // displayTiles: [...val.tileCells],\r\n                clearTiles: [],\r\n                highlightCells: [...highlights],\r\n                shadeCells: []\r\n            });\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [dataService, cellsGridEvent$, event$, filteredCellsRef, cellsUpdate$, contractTiles$, cellTileUpdatesRef, modeRef]);\r\n\r\n    useEffect(() => {\r\n        const sub = cellsUpdate$.subscribe((ev) => {\r\n            const evType = ev[0], payload = ev[1];\r\n            console.log('cellsUpdate$', evType, payload);\r\n\r\n            const cellEvents = event$.getValue();\r\n            if (evType === CellEventTypes.DisplayAll || evType === CellEventTypes.DisplayOwnCells) {\r\n                const unhighlightCells = evType === CellEventTypes.DisplayAll ? [...filteredCellsRef.current] : [];\r\n                modeRef.current = evType === CellEventTypes.DisplayAll ? MyModes.Buy : MyModes.Edit;\r\n                filteredCellsRef.current = (ev[1] as ICellEventData[]).map<ICellsGridEvent>(t => ({\r\n                    cellNumber: t.curr.cellNumber,\r\n                    point: t.curr.point,\r\n                    mouseType: MyCanvasMouseEvents.None\r\n                }));\r\n                const notHighlightedSelected = cellEvents\r\n                    .filter(t => t.mouseType === MyCanvasMouseEvents.Click\r\n                        && unhighlightCells.findIndex(x => x.cellNumber === t.curr.cellNumber) < 0)\r\n                    .map<ICellsGridEvent>(t => ({\r\n                        cellNumber: t.curr.cellNumber,\r\n                        point: t.curr.point,\r\n                        mouseType: t.mouseType\r\n                    }));\r\n                event$.next(cellEvents.filter(t => t.mouseType !== MyCanvasMouseEvents.Click));\r\n                // 1. display border of selected!\r\n                return cellsGridEvent$.next({\r\n                    displayCells: [], clearCells: [...unhighlightCells, ...notHighlightedSelected],\r\n                    displayTiles: [], clearTiles: [],\r\n                    highlightCells: [...filteredCellsRef.current],\r\n                    shadeCells: []\r\n                });\r\n            }\r\n\r\n            // TODO: update from contract event\r\n            if (evType === CellEventTypes.UpdateByContract) {\r\n                return;\r\n            }\r\n\r\n            if (evType === CellEventTypes.Remove) {\r\n\r\n                const afterRemoveCellEvents = cellEvents\r\n                    .filter(t => t.mouseType !== MyCanvasMouseEvents.Click || ev[1].findIndex(x => x.cellNumber === t.curr.cellNumber) < 0);\r\n\r\n\r\n                event$.next([...afterRemoveCellEvents]);\r\n\r\n                cellsGridEvent$.next({\r\n                    displayCells: afterRemoveCellEvents.filter(t => t.mouseType === MyCanvasMouseEvents.Click).map<ICellsGridEvent>(MAP_CURR_CELL_EV_TO_CELL_GRID_EV),\r\n                    clearCells: ev[1].map<ICellsGridEvent>(t => ({ cellNumber: t.cellNumber, point: t.point, mouseType: MyCanvasMouseEvents.Click })),\r\n                    displayTiles: [],\r\n                    clearTiles: [],\r\n                    highlightCells: [],\r\n                    shadeCells: []\r\n                });\r\n\r\n                return;\r\n            }\r\n\r\n            // const afterRemoveCellEvents = cellEvents\r\n            //     .filter(t => t.mouseType !== MyCanvasMouseEvents.Click || payload.findIndex(x => x.curr.cellNumber === t.curr.cellNumber) < 0);\r\n\r\n\r\n            // event$.next([...afterRemoveCellEvents]);\r\n\r\n            // cellsGridEvent$.next({\r\n            //     displayCells: afterRemoveCellEvents.filter(t => t.mouseType === MyCanvasMouseEvents.Click).map<ICellsGridEvent>(MAP_CURR_CELL_EV_TO_CELL_GRID_EV),\r\n            //     clearCells: payload.map<ICellsGridEvent>(MAP_CURR_CELL_EV_TO_CELL_GRID_EV),\r\n            //     displayTiles: [],\r\n            //     clearTiles: [],\r\n            //     highlightCells: [],\r\n            //     shadeCells: []\r\n            // });\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [cellsUpdate$, event$, cellsGridEvent$, modeRef, filteredCellsRef]);\r\n\r\n    useEffect(\r\n        () => {\r\n\r\n            const sub = canvasMouseEvent$.subscribe(([evType, elem]) => {\r\n                const { clientX, clientY } = elem;\r\n                const { offsetLeft, offsetTop } = elem.currentTarget;\r\n\r\n                const [scrollLeft, scrollTop] = boxRef.current ? [boxRef.current.scrollLeft, boxRef.current.scrollTop] : [0, 0];\r\n\r\n                const cellEvents = event$.getValue();\r\n\r\n                // mouse out of grid layout\r\n                if ((clientX - offsetLeft + scrollLeft + cellBorderWidth >= cellsLayoutSizeRef.current[0]) ||\r\n                    (clientX <= offsetLeft) ||\r\n                    (clientY <= offsetTop) ||\r\n                    (clientY - offsetTop + scrollTop + cellBorderWidth >= cellsLayoutSizeRef.current[1])) {\r\n                    const selectedCellEvents = cellEvents.filter(t => t.mouseType !== MyCanvasMouseEvents.Move);\r\n                    cellsGridEvent$.next({\r\n                        displayCells: selectedCellEvents.map<ICellsGridEvent>(MAP_CURR_CELL_EV_TO_CELL_GRID_EV),\r\n                        clearCells: cellEvents\r\n                            .filter(t =>\r\n                                t.mouseType === MyCanvasMouseEvents.Move\r\n                                && filteredCellsRef.current.findIndex(ft => ft.cellNumber === t.curr.cellNumber) < 0\r\n                            )\r\n                            .map<ICellsGridEvent>(MAP_CURR_CELL_EV_TO_CELL_GRID_EV),\r\n                        displayTiles: [],\r\n                        clearTiles: [],\r\n                        highlightCells: [...filteredCellsRef.current],\r\n                        shadeCells: []\r\n                    });\r\n                    event$.next([...selectedCellEvents]);\r\n                    return;\r\n                }\r\n\r\n                const cellData = getCellByClick(\r\n                    clientX + scrollLeft - offsetLeft,\r\n                    clientY + scrollTop - offsetTop,\r\n                    { inRowCount: rowsDataRef.current[0], cellW: cellWidth + cellBorderWidth, cellH: cellHeight + cellBorderWidth }\r\n                );\r\n\r\n                const newCellData: ICellData = { cellNumber: cellData.cellNumber, point: [cellData.x, cellData.y] };\r\n\r\n\r\n                if (evType === MyCanvasMouseEvents.Move && !!cellEvents.find(t => t.mouseType === evType && t.curr.cellNumber === cellData.cellNumber)) {\r\n                    return;\r\n                }\r\n\r\n                // console.log('\\n\\n-----');\r\n                // console.log('cellEvents', [...cellEvents]);\r\n                // console.log('----- cellData -- ', cellData);\r\n\r\n                // 1        move to new cell (clear last, display new Hover)\r\n                // 2        click new cell (display new selected)\r\n                // 3        click on selected (clear selected, display hover)\r\n                // 4        move to selected (display Selected-Hover)\r\n                // 5        move on the same (no action)\r\n                // 6*        move Out (clear last --- ok)\r\n                //  remove from EVENT:  [ click twice on the same ]\r\n\r\n                const MODE = modeRef.current;\r\n                const CURRENT_ADDR = currentAcc$.getValue();\r\n                const contractTiles = contractTiles$.getValue();\r\n\r\n                let CLICK_TO_NEW_CELL = evType === MyCanvasMouseEvents.Click;\r\n                let ADD_NEW_MOVE_CELL = cellEvents.length && evType === MyCanvasMouseEvents.Move;\r\n\r\n                const EDIT_NOT_MINE_TILE_OE_EMPTY = MODE === MyModes.Edit && CLICK_TO_NEW_CELL &&\r\n                    (!contractTiles[newCellData.cellNumber] || contractTiles[newCellData.cellNumber][1].tile.owner !== CURRENT_ADDR);\r\n\r\n                if (EDIT_NOT_MINE_TILE_OE_EMPTY) CLICK_TO_NEW_CELL = false;\r\n                const result: { display: ICellsGridEvent[], clear: ICellsGridEvent[], finalCellEvents: ICellEventData[] } = {\r\n                    display: !cellEvents.length && !EDIT_NOT_MINE_TILE_OE_EMPTY ? [{ ...newCellData, mouseType: evType }] : [],\r\n                    clear: [],\r\n                    finalCellEvents: !cellEvents.length && !EDIT_NOT_MINE_TILE_OE_EMPTY ? [{ mouseType: evType, lastCell: { cellNumber: -1, point: [0, 0] }, curr: { ...newCellData } }] : []\r\n                };\r\n\r\n\r\n                cellEvents.forEach(t => {\r\n\r\n                    if (evType === MyCanvasMouseEvents.Click) {\r\n                        // console.log('%c cell event', 'background-color: darkcyan; color: white', t);\r\n                        // if MODE is EDIT and cell is not mine - skip!\r\n                        // if MODE is BUY and cell is mine - skip!\r\n                        // all above - if CURRENT_ADDR is not EMPTY\r\n                        // console.log('%c ev ', 'color: green', t, contractTiles[t.curr.cellNumber], CURRENT_ADDR);\r\n\r\n                        // click to new cell that is not mine or empty in EDIT MODE\r\n                        if (MODE === MyModes.Edit && t.mouseType === MyCanvasMouseEvents.Click && (!contractTiles[t.curr.cellNumber] || contractTiles[t.curr.cellNumber][1].tile.owner !== CURRENT_ADDR)) {\r\n                            CLICK_TO_NEW_CELL = false;\r\n                            return;\r\n                        }\r\n                        // click on another cell: display selected owned tiles!\r\n                        if (MODE === MyModes.Edit && t.mouseType === MyCanvasMouseEvents.Click && !EDIT_NOT_MINE_TILE_OE_EMPTY) {\r\n                            if (t.curr.cellNumber !== newCellData.cellNumber) {\r\n                                result.display.push({ ...t.curr, mouseType: t.mouseType });\r\n                            }\r\n                        }\r\n                        // TODO: click for BUYING on empty cell - is OK (yet)\r\n                        // console.log('t.contractTile is buy', t.curr.cellNumber);\r\n                        // console.log('t.contractTile is CURRENT_ADDR', CURRENT_ADDR, contractTiles[t.curr.cellNumber]);\r\n                        // console.log('t.contractTile is owner', contractTiles[t.curr.cellNumber] && contractTiles[t.curr.cellNumber][1].tile.owner);\r\n                        // console.log('t.contractTile is owner == myAddr', contractTiles[t.curr.cellNumber] && contractTiles[t.curr.cellNumber][1].tile.owner === CURRENT_ADDR);\r\n                        if (MODE === MyModes.Buy && t.mouseType === MyCanvasMouseEvents.Click && contractTiles[t.curr.cellNumber] && contractTiles[t.curr.cellNumber][1].tile.owner === CURRENT_ADDR) {\r\n                            return;\r\n                        }\r\n\r\n                        if (MODE === MyModes.Buy) {\r\n                            // click on new [ NON-EDIT mode ] \r\n                            // - ignore selected (only one selected is allowed)\r\n                            if (t.curr.cellNumber !== newCellData.cellNumber) {\r\n                                result.clear.push({ ...t.curr, mouseType: evType });\r\n                                return;\r\n                            }\r\n                        }\r\n\r\n                        if (t.curr.cellNumber === newCellData.cellNumber && t.mouseType === evType) {\r\n                            CLICK_TO_NEW_CELL = false;\r\n                            // 3:  click on selected (clear selected, display hover)\r\n                            result.clear.push({ ...t.curr, mouseType: evType });\r\n                            // no display hover (click on hover Code [3*] do that)\r\n                            return;\r\n                        }\r\n                        if (t.curr.cellNumber === newCellData.cellNumber && t.mouseType !== evType) {\r\n                            // 3*   click on hovered (display move cell)\r\n                            result.display.push({ ...newCellData, mouseType: MyCanvasMouseEvents.Move });\r\n                        }\r\n                        result.finalCellEvents.push({ ...t });\r\n                    }\r\n                    if (evType === MyCanvasMouseEvents.Move) {\r\n                        if (t.mouseType === evType && t.curr.cellNumber === newCellData.cellNumber) {\r\n                            ADD_NEW_MOVE_CELL = false;\r\n                            // 5:  move on the same (no display, no clear)\r\n                            result.finalCellEvents.push({ ...t });\r\n                            return;\r\n                        }\r\n                        if (t.curr.cellNumber === newCellData.cellNumber && t.mouseType === MyCanvasMouseEvents.Click) {\r\n                            // 4:  move to selected (display Selected-Hover)\r\n                            result.finalCellEvents.push({ ...t });\r\n                            result.display.push({ ...t.curr, mouseType: t.mouseType });\r\n                            return;\r\n                        }\r\n                        if (t.mouseType === evType && t.curr.cellNumber !== newCellData.cellNumber) {\r\n                            ADD_NEW_MOVE_CELL = false;\r\n                            // 1:  move to new cell (clear last, display new Hover)\r\n                            //     move to new cell\r\n                            result.clear.push({ ...t.curr, mouseType: evType });\r\n                            result.finalCellEvents.push({ mouseType: t.mouseType, lastCell: { ...t.curr }, curr: { ...newCellData } });\r\n                            //     display new Hover\r\n                            result.display.push({ ...newCellData, mouseType: evType });\r\n                            return;\r\n                        }\r\n                        result.finalCellEvents.push({ ...t });\r\n                        result.display.push({ ...t.curr, mouseType: t.mouseType });\r\n                    }\r\n                });\r\n\r\n                if (ADD_NEW_MOVE_CELL) {\r\n                    // move on new cell first time\r\n                    result.finalCellEvents.push({ mouseType: evType, lastCell: { cellNumber: -1, point: [0, 0] }, curr: { ...newCellData } });\r\n                    result.display.push({ ...newCellData, mouseType: evType });\r\n                }\r\n                if (CLICK_TO_NEW_CELL) {\r\n                    // 2:  click new cell (display new selected)\r\n                    if (MODE === MyModes.Buy && contractTiles[newCellData.cellNumber] && contractTiles[newCellData.cellNumber][1].tile.owner === CURRENT_ADDR) {\r\n                        return;\r\n                    }\r\n                    result.finalCellEvents.push({ mouseType: evType, lastCell: { cellNumber: -1, point: [0, 0] }, curr: { ...newCellData } });\r\n                    result.display.push({ ...newCellData, mouseType: evType });\r\n                }\r\n                if (evType === MyCanvasMouseEvents.Click) {\r\n                    if (EDIT_NOT_MINE_TILE_OE_EMPTY) {\r\n                        result.finalCellEvents = result.finalCellEvents.filter(\r\n                            t => t.mouseType !== MyCanvasMouseEvents.Click\r\n                        );\r\n                    }\r\n                    console.log('final res', CLICK_TO_NEW_CELL, { ...result });\r\n                }\r\n                if (result.display.length || result.clear.length) {\r\n                    cellsGridEvent$.next({\r\n                        displayCells: [...result.display],\r\n                        clearCells: result.clear.filter(t => filteredCellsRef.current.findIndex(ft => ft.cellNumber === t.cellNumber) < 0),\r\n                        displayTiles: [],\r\n                        clearTiles: [],\r\n                        highlightCells: filteredCellsRef.current.filter(t => result.display.findIndex(ct => ct.cellNumber === t.cellNumber) < 0),\r\n                        shadeCells: []\r\n                    });\r\n                }\r\n                if (evType === MyCanvasMouseEvents.Click) {\r\n                    console.log('\\nresult', { ...result });\r\n                }\r\n                event$.next([...result.finalCellEvents]);\r\n            });\r\n\r\n            return () => sub.unsubscribe();\r\n\r\n        },\r\n        [\r\n            boxRef,\r\n            cellsLayoutSizeRef,\r\n            rowsDataRef,\r\n            event$,\r\n            modeRef,\r\n            contractTiles$,\r\n            currentAcc$,\r\n            cellsGridEvent$,\r\n            canvasMouseEvent$,\r\n            filteredCellsRef,\r\n            cellBorderWidth,\r\n            cellWidth,\r\n            cellHeight\r\n        ]\r\n    );\r\n\r\n    return (\r\n        <div id=\"cells-body\" className=\"overflow\" ref={ onBoxRef }>\r\n            <CanvasComponent\r\n                width={ sizeWithOuter[0] }\r\n                height={ sizeWithOuter[1] }\r\n                canvas2dCtxInList$={ canvas2dCtxInList$ }\r\n                event$={ canvasMouseEvent$ }\r\n            />\r\n            {\r\n                sizeWithOuter[0] &&\r\n                sizeWithOuter[1] &&\r\n                <CellsGrid\r\n                    event$={ cellsGridEvent$ }\r\n                    canvas2dCtxInList$={ canvas2dCtxInList$ }\r\n                    amount={ cellsAmount }\r\n                    cellW={ cellSize[0] }\r\n                    cellH={ cellSize[1] }\r\n                    cellBorderWidth={ cellBorderWidth }\r\n                    canvasSize={ [sizeWithOuter[0], sizeWithOuter[1]] }\r\n                />\r\n            }\r\n        </div>\r\n    )\r\n};\r\n\r\nexport default Component;","import React, { useEffect, useMemo, useRef, useState } from 'react';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\nimport Button from '../../components/Button';\r\nimport Input from '../../components/Input';\r\nimport Modal from '../../components/Modal';\r\nimport { CartEvents, TilesEventCart, ICellEventData, IUnmintedTileState } from '../../interfaces/cells';\r\nimport { ContractTileInfo, FormTileData } from '../../services/interfaces';\r\n\r\nexport interface ICartModalProps {\r\n    event$: Subject<TilesEventCart>;\r\n}\r\n\r\nenum CartOpenTypes {\r\n    None = 0,\r\n    BuyCellsMode = 1,\r\n    ModifyCellsMode = 2,\r\n}\r\n\r\ntype StateWithOpenVariant = [true, ICellEventData[]];\r\ntype StateWithCloseVariant = [false];\r\ntype StateWithOpenStatus = StateWithOpenVariant | StateWithCloseVariant;\r\n\r\nconst CartModal = (props: ICartModalProps) => {\r\n    const { event$ } = props;\r\n    const modalEvent$ = useMemo(() => new Subject(), []);\r\n    const remove$ = useMemo(() => new Subject<IUnmintedTileState>(), []);\r\n    const cartEvent$ = useMemo(() => new Subject<TilesEventCart>(), []);\r\n\r\n    const [tilesState, setTilesState] = useState<[CartOpenTypes, IUnmintedTileState[]]>([CartOpenTypes.None, []]);\r\n    const tilesRef = useRef<IUnmintedTileState[]>([]);\r\n\r\n    const groupAvatarUrl = tilesState[1].reduce<string>((acc, t) => {\r\n        if (!t.tile) return acc;\r\n        if (acc && t.tile.url) return '';\r\n        return t.tile.url || acc;\r\n    }, '');\r\n\r\n    const input$ = useMemo(() => new BehaviorSubject<[string, keyof FormTileData | null]>([groupAvatarUrl || '', null]), [groupAvatarUrl]);\r\n    const inputDataRef = useRef<Partial<FormTileData>>({});\r\n\r\n    useEffect(() => {\r\n        const sub = input$.subscribe(([val, key]) => {\r\n            if (key) {\r\n                inputDataRef.current[key] = val;\r\n            }\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [input$, inputDataRef]);\r\n\r\n    // const [state, setState] = useState<StateWithOpenStatus>([false]);\r\n    // const stateRef = useRef<ICellEventData[]>(state[1] || []);\r\n    useEffect(() => {\r\n        const launcherSub = event$.subscribe(val => {\r\n            console.log('%c event$ in cart-modal: ', 'border: 1px solid green', val, input$.getValue());\r\n            // if (val.type === CartEvents.Open) {\r\n            //     stateRef.current = [...val.payload];\r\n            //     setState([true, [...val.payload]]);\r\n            //     setTilesState([false, []]);\r\n            // }\r\n            if (val.type === CartEvents.Modify || val.type === CartEvents.Open) {\r\n                input$.next(['', null]);\r\n                tilesRef.current = [...val.payload];\r\n                setTilesState([val.type === CartEvents.Modify ? CartOpenTypes.ModifyCellsMode : CartOpenTypes.BuyCellsMode, [...val.payload]]);\r\n                cartEvent$.next(val);\r\n            }\r\n        });\r\n        const sub = cartEvent$.subscribe((val) => {\r\n            console.log('cart event', val, [...tilesRef.current]);\r\n            if ([CartEvents.Close, CartEvents.Save, CartEvents.Buy].includes(val.type)) {\r\n                if (val.type === CartEvents.Buy) {\r\n                    if (tilesRef.current.length) {\r\n                        event$.next({\r\n                            type: CartEvents.Buy,\r\n                            params: inputDataRef.current && { ...inputDataRef.current },\r\n                            payload: tilesRef.current.map(t => ({ ...t })),\r\n                            groupUrl: input$.getValue()[0]\r\n                        });\r\n                    }\r\n                } else if (val.type === CartEvents.Save) {\r\n                    if (tilesRef.current.length) {\r\n                        const inputData = inputDataRef.current;\r\n                        event$.next({\r\n                            type: CartEvents.SaveTiles,\r\n                            payload: [...tilesRef.current],\r\n                            groupUrl: inputData ? inputData.url || '' : '', //input$.getValue()[0],\r\n                            params: inputData && { ...inputData }\r\n                        });\r\n                    } else {\r\n                        event$.next({ ...val });\r\n                    }\r\n                }\r\n                tilesRef.current = [];\r\n                input$.next(['', null]);\r\n                setTilesState([CartOpenTypes.None, []]);\r\n            }\r\n\r\n            if (val.type === CartEvents.RemoveItems) {\r\n                tilesRef.current = tilesRef.current.filter(t => val.payload.findIndex(x => x.cellNumber === t.cellNumber) < 0);\r\n                setTilesState([CartOpenTypes.ModifyCellsMode, [...tilesRef.current]]);\r\n                event$.next(val);\r\n            }\r\n        });\r\n        return () => {\r\n            launcherSub.unsubscribe();\r\n            sub.unsubscribe();\r\n        };\r\n    }, [event$, modalEvent$, tilesRef, input$, inputDataRef]);\r\n\r\n    useEffect(() => {\r\n        const sub = remove$.subscribe((val) => {\r\n            console.log('remove >', val);\r\n            cartEvent$.next({ type: CartEvents.RemoveItems, payload: [{ ...val }], groupUrl: '' });\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [event$, remove$]);\r\n\r\n    console.log('state CartModal: ', tilesState);\r\n\r\n    return (\r\n        <div>\r\n            {\r\n                <Modal title=\"Crypto tiles\" width={ 770 } height={ 450 } event$={ cartEvent$ } open={ tilesState[0] !== CartOpenTypes.None }>\r\n                    <div className=\"flex-cnt item wrap content-start overflow px-2\">\r\n                        {\r\n                            tilesState[0] === CartOpenTypes.ModifyCellsMode\r\n                            && tilesState[1].length > 1\r\n                            && <div className=\"flex-cnt item wrap fb-10 px-2 my-2\">\r\n                                <Button color=\"secondary\" noActive title={ tilesState[1].length > 1 ? 'group url' : \"url\" } small />\r\n                                <Input event$={ input$ } action=\"url\" value={ groupAvatarUrl } />\r\n                            </div>\r\n                        }\r\n                        <div className=\"flex-cnt item justify-start fb-10 wrap px-2 py-3\">\r\n                            {\r\n                                tilesState[0] === CartOpenTypes.ModifyCellsMode && tilesState[1].length > 1 && <div className=\"flex-cnt item fb-10 my-2\">\r\n                                    <Button color=\"secondary\" noActive title=\"group tiles\" small />\r\n                                </div>\r\n                            }\r\n                            {\r\n                                tilesState[0] === CartOpenTypes.ModifyCellsMode\r\n                                && tilesState[1].length > 1\r\n                                && tilesState[1].map(cellData =>\r\n                                    <div\r\n                                        key={ cellData.cellNumber }\r\n                                        className=\"flex-cnt item wrap fb-2 align-center shrink mx-1 px-3 py-1\"\r\n                                        style={ { marginBottom: 8, backgroundColor: 'white' } }\r\n                                    >\r\n                                        <div className=\"flex-cnt item fb-4 modal_cell-item\">{ cellData.cellNumber + 1 }</div>\r\n                                        <div className=\"flex-cnt item fb-3 justify-end\">\r\n                                            <Button action={ cellData } light color=\"error\" title=\"X\" small event$={ remove$ } />\r\n                                        </div>\r\n                                    </div>\r\n                                )\r\n                            }\r\n                            {\r\n                                (tilesState[0] === CartOpenTypes.BuyCellsMode\r\n                                    || (tilesState[0] === CartOpenTypes.ModifyCellsMode && tilesState[1].length === 1))\r\n                                && <div className=\"flex-cnt item wrap justify-start fb-10\">\r\n                                    {\r\n                                        tilesState[1].map(cellData =>\r\n                                            <div\r\n                                                key={ cellData.cellNumber }\r\n                                                className=\"flex-cnt item wrap fb-10 align-center shrink mx-1 px-3 py-1\"\r\n                                                style={ { marginBottom: 8, backgroundColor: 'white' } }\r\n                                            >\r\n                                                <div className=\"flex-cnt item fb-4 shrink\">\r\n                                                    <Button color=\"header\" textAlign=\"left\" noActive title=\"price (Eth)\" small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item justify-end fb-4\">\r\n                                                    <Button color=\"info\" noActive title={ `# ${cellData.cellNumber + 1}` } small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item shrink fb-10 mt-1 mb-4\">\r\n                                                    <Input color=\"header\" event$={ input$ } action=\"price\" value={ cellData.token ? '' + cellData.token.price : '' } />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item fb-4 shrink\">\r\n                                                    <Button color=\"close\" textAlign=\"left\" noActive title=\"image url\" small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item fb-10 mt-1 mb-4\">\r\n                                                    <Input event$={ input$ } action=\"url\" value={ cellData.tile ? cellData.tile.url || '' : '' } />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item fb-4 shrink\">\r\n                                                    <Button color=\"close\" textAlign=\"left\" noActive title=\"title\" small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item shrink fb-10 mt-1 mb-4\">\r\n                                                    <Input event$={ input$ } action=\"title\" color=\"header\" value={ cellData.tile ? '' + cellData.tile.title : '' } />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item fb-4 shrink\">\r\n                                                    <Button color=\"close\" textAlign=\"left\" noActive title=\"bounded tiles\" small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item shrink fb-10 wrap\">\r\n                                                    {\r\n                                                        cellData.tile &&\r\n                                                        cellData.tile.boundedTiles.map(x =>\r\n                                                            <div key={ x.toString() } className=\"flex-cnt item shrink my-1 mx-2\">\r\n                                                                <Button color=\"base\" noActive title={ x.toString() } small />\r\n                                                            </div>\r\n                                                        )\r\n                                                    }\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item fb-4 mt-4 shrink\">\r\n                                                    <Button color=\"close\" textAlign=\"center\" noActive title=\"owner address\" small />\r\n                                                </div>\r\n                                                <div className=\"flex-cnt item shrink fb-10 mt-1 mb-4\">\r\n                                                    <Input noActive color=\"header\" value={ cellData.tile ? '' + cellData.tile.owner : '' } />\r\n                                                </div>\r\n                                            </div>\r\n                                        )\r\n                                    }\r\n                                </div>\r\n                            }\r\n                        </div>\r\n                    </div>\r\n                </Modal>\r\n            }\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CartModal;","import CellsLayout from './CellsLayout';\r\n\r\nexport default CellsLayout;","import React, { PropsWithChildren, useCallback, useState } from 'react';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\n\r\n\r\nexport interface IInputProps<T = any> {\r\n    title?: string;\r\n    value?: string;\r\n    action?: T;\r\n    noActive?: boolean;\r\n    light?: boolean;\r\n    small?: boolean;\r\n    color?: 'header' | 'base' | 'active' | 'primary' | 'secondary' | 'info' | 'error' | 'close';\r\n    event$?: Subject<[string, T]>;\r\n}\r\n\r\nconst Input = (props: PropsWithChildren<IInputProps>) => {\r\n    const { value, event$, noActive, light, small, color, action } = props;\r\n    const [state, setState] = useState(value || '');\r\n    const onChangeHandler = useCallback<React.ChangeEventHandler<HTMLInputElement>>((event) => {\r\n        setState(event.currentTarget.value);\r\n        event$ && event$.next([event.currentTarget.value, action]);\r\n    }, [event$, action]);\r\n\r\n    const modifiersTxt = [noActive && 'no-action', light && 'light', small && 'small', color].filter(Boolean).map(t => `text-input--${t}`);\r\n    return (\r\n        <div className={ ['text-input', ...modifiersTxt].join(' ') }>\r\n            <input type=\"text\" value={ state } onChange={ onChangeHandler } disabled={ noActive } />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Input;","import React, { PropsWithChildren, useEffect, useState } from 'react';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\nimport { CartEvents, TilesEventCart } from '../interfaces/cells';\r\nimport Button from './Button';\r\n\r\n\r\nexport interface IModalProps {\r\n    title: string;\r\n    width: number;\r\n    height: number;\r\n    event$: Subject<TilesEventCart>;\r\n    open: boolean;\r\n}\r\n\r\nconst Modal = (props: PropsWithChildren<IModalProps>) => {\r\n    const { title, width, height, event$, open } = props;\r\n    const [state, setState] = useState<TilesEventCart>({ type: CartEvents.Close, payload: [], groupUrl: '' });\r\n    useEffect(() => {\r\n        console.log('useEffect in modal....');\r\n        const sub = event$.subscribe(ev => {\r\n            console.log('ev in modal: ', ev);\r\n            if ([CartEvents.Modify, CartEvents.Open].includes(ev.type)) setState(ev);\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [event$]);\r\n\r\n    console.log('Modal state', state);\r\n\r\n    if (!open) return null;\r\n\r\n    const ifNewCell = !!state.payload.filter(t => !t.token && !t.tile).length;\r\n    let BTN_TITLE = state && state.type === CartEvents.Modify ? \"Save\" : \"Buy\";\r\n    BTN_TITLE = state && state.type === CartEvents.Open ? \"Buy\" : BTN_TITLE;\r\n    BTN_TITLE = ifNewCell ? 'Mint' : BTN_TITLE;\r\n\r\n    const EV_NAME = state && state.type === CartEvents.Open || ifNewCell ? CartEvents.Buy : CartEvents.Save;\r\n\r\n    return (\r\n        <div id=\"modal-overlay-cnt\">\r\n            <div id=\"modal-cnt\" style={ { width, height, top: '25%', marginLeft: -0.5 * width } }>\r\n                <div className=\"header\">\r\n                    <Button light color=\"header\" noActive title={ title } />\r\n                    <div className=\"flex-cnt\">\r\n                        <Button\r\n                            event$={ event$ }\r\n                            action={ { type: EV_NAME, payload: [] } }\r\n                            light\r\n                            color=\"active\"\r\n                            title={ BTN_TITLE } />\r\n                        <div className=\"flex-cnt item mx-1\"></div>\r\n                        <Button\r\n                            event$={ event$ }\r\n                            action={ { type: CartEvents.Close, payload: [] } }\r\n                            light\r\n                            color=\"close\"\r\n                            title=\"Close\" />\r\n                    </div>\r\n                </div>\r\n                <div className=\"content\">{ props.children }</div>\r\n                <div className=\"footer\"></div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Modal;","export default {\r\n    apiKey: \"AIzaSyD8Ad1yitALcRL8lBafsDVB3cqWXl4r0hY\",\r\n    authDomain: \"tiles-c734c.firebaseapp.com\",\r\n    projectId: \"tiles-c734c\",\r\n    storageBucket: \"tiles-c734c.appspot.com\",\r\n    messagingSenderId: \"895094851367\",\r\n    appId: \"1:895094851367:web:e231bfb9953e7edc350b02\"\r\n};","import { BehaviorSubject } from \"rxjs/internal/BehaviorSubject\";\r\nimport { ITileState, IUnmintedTileState } from \"../interfaces/cells\";\r\n\r\nexport type AccountAddr = string & { _TYPE_: \"AccountAddr\" };\r\nexport type ContractTokenID = number & { _TYPE_: \"ContractTokenID\" };\r\nexport type ContractTileID = number & { _TYPE_: \"ContractTileID\" };\r\n\r\nexport const EMPTY_ADDR = \"<no-account>\" as AccountAddr;\r\n\r\n\r\nexport type FormTileData = {\r\n    title: string;\r\n    price: string;\r\n    url: string;\r\n    description: string;\r\n};\r\n\r\nexport type ContractTileInfo = {\r\n    _id: any;\r\n    id: ContractTileID;\r\n    owner: AccountAddr;\r\n    tokenId: ContractTokenID;\r\n    url: string;\r\n    title: string;\r\n    version: number;\r\n    boundedTiles: ContractTileID[];\r\n};\r\n\r\nexport type ContractTokenInfo = {\r\n    _id: any;\r\n    id: ContractTokenID;\r\n    owner: AccountAddr;\r\n    price: string;\r\n    url?: string;\r\n};\r\n\r\nexport type DataServiceState = {\r\n    tileCells: ITileState[];\r\n    lastUpdate: number;\r\n}\r\n\r\nexport interface IDataService {\r\n    connect(): Promise<boolean>;\r\n    getState(): BehaviorSubject<DataServiceState>;\r\n    getAccount(): AccountAddr | null;\r\n    getTileInfo(id: ContractTileID): Promise<ContractTileInfo | undefined>;\r\n    fetchTokenInfo(id: ContractTokenID): Promise<ContractTokenInfo>;\r\n    fetchTiles(): Promise<ContractTileInfo[]>;\r\n    groupTiles(tiles: ITileState[], tileData: Partial<FormTileData>): Promise<[boolean, string]>;\r\n    buyTiles(tiles: ITileState[], tileData: Partial<FormTileData>): Promise<[boolean, string]>;\r\n    mintTiles(tiles: IUnmintedTileState[], tileData: Partial<FormTileData>): Promise<[boolean, string]>;\r\n}","import { getPointByCellNumber } from \"../helpers/canvasMath\";\r\nimport { ITileState } from \"../interfaces/cells\";\r\nimport { ContractTileInfo, ContractTokenInfo } from \"./interfaces\";\r\n\r\nexport const fromContractTile = (tile: ContractTileInfo, token: ContractTokenInfo): ITileState => {\r\n    return {\r\n        tile,\r\n        token,\r\n        cellNumber: tile.id,\r\n        point: getPointByCellNumber(tile.id)\r\n    }\r\n};","import { FirebaseApp, initializeApp } from \"firebase/app\";\r\nimport {\r\n    getFirestore,\r\n    collection,\r\n    getDocs,\r\n    getDoc,\r\n    updateDoc,\r\n    addDoc,\r\n    Firestore,\r\n    CollectionReference,\r\n    doc,\r\n    query,\r\n    where,\r\n    QuerySnapshot,\r\n    DocumentData,\r\n} from 'firebase/firestore/lite';\r\nimport testFirebaseConfig from './testDbConfig';\r\n\r\nimport { BehaviorSubject } from \"rxjs/internal/BehaviorSubject\";\r\nimport { ITileState, IUnmintedTileState } from \"../interfaces/cells\";\r\nimport {\r\n    AccountAddr,\r\n    ContractTileID,\r\n    ContractTileInfo,\r\n    ContractTokenID,\r\n    ContractTokenInfo,\r\n    DataServiceState,\r\n    EMPTY_ADDR,\r\n    FormTileData,\r\n    IDataService\r\n} from \"./interfaces\";\r\nimport { fromContractTile } from \"./mappers\";\r\n\r\nconst TEST_OWNER_ADDR = \"test-owner-1\" as AccountAddr;\r\n\r\nconst ERROR_TOKEN: ContractTokenInfo = {\r\n    _id: 1,\r\n    id: -1 as ContractTokenID,\r\n    owner: EMPTY_ADDR,\r\n    price: '',\r\n    url: ''\r\n};\r\n\r\nconst tileToFirebaseMapper = (item: ContractTileInfo): any => {\r\n    const idPart = item._id ? { _id: item._id } : {};\r\n    return {\r\n        ...idPart,\r\n        id: '' + item.id,\r\n        owner: item.owner,\r\n        tokenId: '' + item.tokenId,\r\n        title: item.title,\r\n        url: item.url,\r\n        version: item.version || 0,\r\n        boundedTiles: item.boundedTiles ? item.boundedTiles.map(t => '' + t).join(',') : ''\r\n    };\r\n};\r\n\r\nconst tileFirebaseMapper = (item: any): ContractTileInfo => {\r\n    return {\r\n        _id: item._id,\r\n        version: item.version || 0,\r\n        id: (Number(item.id)) as ContractTileID,\r\n        owner: item.owner,\r\n        tokenId: (Number(item.tokenId)) as ContractTokenID,\r\n        title: item.title,\r\n        url: item.url,\r\n        boundedTiles: item.boundedTiles ? ('' + item.boundedTiles).split(',').map(t => (Number(t)) as ContractTileID) : []\r\n    };\r\n};\r\n\r\nconst tokenFirebaseMapper = (item: any): ContractTokenInfo => {\r\n    return {\r\n        _id: item._id,\r\n        id: (Number(item.id)) as ContractTokenID,\r\n        owner: '' as AccountAddr,\r\n        price: item.price,\r\n        url: ''\r\n    };\r\n};\r\n\r\nconst tokenToFirebaseMapper = (item: ContractTokenInfo): any => {\r\n    const idPart = item._id ? { _id: item._id } : {};\r\n    return {\r\n        ...idPart,\r\n        id: (Number(item.id)) as ContractTokenID,\r\n        owner: '' as AccountAddr,\r\n        price: item.price,\r\n        url: ''\r\n    };\r\n};\r\n\r\nexport default class DataService implements IDataService {\r\n    private _account: AccountAddr | null = null;\r\n    private _state: BehaviorSubject<DataServiceState> = new BehaviorSubject<DataServiceState>({\r\n        lastUpdate: 0,\r\n        tileCells: []\r\n    });\r\n    private _firebaseApp: FirebaseApp;\r\n    private _db: Firestore;\r\n    private _tilesCollection: CollectionReference;\r\n    private _tokensCollection: CollectionReference;\r\n    constructor() {\r\n        this._firebaseApp = initializeApp(testFirebaseConfig);\r\n        this._db = getFirestore(this._firebaseApp);\r\n        this._tilesCollection = collection(this._db, 'tiles');\r\n        this._tokensCollection = collection(this._db, 'tokens');\r\n    }\r\n    getState(): BehaviorSubject<DataServiceState> {\r\n        return this._state;\r\n    }\r\n    connect(): Promise<boolean> {\r\n        this._account = TEST_OWNER_ADDR;\r\n        return new Promise(resolve => setTimeout(() => resolve(true), 2000));\r\n    }\r\n    getAccount(): AccountAddr | null {\r\n        return this._account;\r\n    }\r\n    async getTileInfo(id: ContractTileID): Promise<ContractTileInfo | undefined> {\r\n        try {\r\n            const result = await getDoc(doc(this._db, 'tiles', '' + id));\r\n            return tileFirebaseMapper({ ...result.data(), _id: result.id });\r\n        } catch (error) {\r\n            throw error;\r\n        }\r\n    }\r\n    async fetchTokenInfo(id: ContractTokenID): Promise<ContractTokenInfo> {\r\n        try {\r\n            const result = await getDoc(doc(this._db, 'tokens', '' + id));\r\n            return tokenFirebaseMapper({ ...result.data(), _id: result.id });\r\n        } catch (error) {\r\n            throw error;\r\n        }\r\n    }\r\n    protected async fetchTokensByIds(ids: ContractTokenID[]): Promise<ContractTokenInfo[]> {\r\n        return Promise.all(ids.map(tokenId => this.fetchTokenInfo(tokenId)));\r\n    }\r\n\r\n    async fetchTiles(): Promise<ContractTileInfo[]> {\r\n\r\n        try {\r\n            const [tilesSnapshot, tokesSnapshot] = await Promise.all([getDocs(this._tilesCollection), getDocs(this._tokensCollection)]);\r\n            const tiles = tilesSnapshot.docs.map(doc => ({ ...doc.data(), _id: doc.id })).map(tileFirebaseMapper);\r\n            const tokens = tokesSnapshot.docs.map(doc => ({ ...doc.data(), _id: doc.id })).map(tokenFirebaseMapper);\r\n            console.log('%c tiles, tokens: ', 'border: 1px solid blue', tilesSnapshot.docs, tokesSnapshot.docs.map(doc => doc.data()));\r\n\r\n            this._state.next({\r\n                lastUpdate: new Date().getTime(),\r\n                tileCells: tiles.map(contractTile => {\r\n                    const token = tokens.find(t => t.id === contractTile.tokenId);\r\n                    return fromContractTile(contractTile, token || ERROR_TOKEN);\r\n                })\r\n            });\r\n\r\n            return [...tiles];\r\n\r\n        } catch (error) {\r\n            console.log('error with loading docs from collections: ', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async groupTiles(tiles: ITileState[], formTileData: Partial<FormTileData>): Promise<[boolean, string]> {\r\n        // 1. send to MANAGING_CONTRACT groups of tiles\r\n        // 2. update tiles (from TIMER, but for TEST: update manually here)\r\n        const sortedTiles = tiles.sort((a, b) => a.cellNumber > b.cellNumber ? 1 : -1);\r\n        console.log('%c group tiles ', 'background-color: orange; color: green', tiles, [...sortedTiles]);\r\n        if (!tiles.length) {\r\n            return [false, 'no tiles for grouping'];\r\n        }\r\n        const updContractTilePart: Partial<ContractTileInfo> = sortedTiles.length === 1\r\n            ? { url: formTileData.url || '', title: formTileData.title || '' }\r\n            : {};\r\n        const tokensPromises = sortedTiles.length === 1 ? [\r\n            updateDoc(\r\n                doc(this._db, 'tokens', sortedTiles[0].token._id),\r\n                tokenToFirebaseMapper({\r\n                    ...sortedTiles[0].token,\r\n                    price: formTileData.price || sortedTiles[0].token.price\r\n                })\r\n            )\r\n        ] : [];\r\n        try {\r\n            await Promise.all([\r\n                ...tokensPromises,\r\n                ...sortedTiles.map((tileData, i) => {\r\n                    const ifParentBounds = formTileData.url && !i ? [...sortedTiles.map(k => k.tile.id)] : [];\r\n                    const ifInGroupTileBounds = formTileData.url && !!i ? [sortedTiles[0].tile.id] : []\r\n                    return updateDoc(\r\n                        doc(\r\n                            this._db, 'tiles',\r\n                            tileData.tile._id\r\n                        ),\r\n                        tileToFirebaseMapper({\r\n                            ...tileData.tile,\r\n                            ...updContractTilePart,\r\n                            url: !i ? formTileData.url || '' : '',\r\n                            version: tileData.tile.version + 1,\r\n                            boundedTiles: !i ? [...ifParentBounds] : [...ifInGroupTileBounds]\r\n                        })\r\n                    )\r\n                })\r\n            ]);\r\n            await this.fetchTiles();\r\n            return [true, ''];\r\n        } catch (error) {\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async buyTiles(tiles: ITileState[], formTileData: Partial<FormTileData>): Promise<[boolean, string]> {\r\n        // 1. send to MANAGING_CONTRACT groups of tiles\r\n        // 2. update tiles (from TIMER, but for TEST: update manually here)\r\n        console.log('%c buy tiles ', 'background-color: orange; color: darkcyan', tiles);\r\n        if (!tiles.length) {\r\n            return [false, 'no tiles for buying'];\r\n        }\r\n\r\n        const currAcc = this.getAccount();\r\n\r\n        if (!currAcc) return [false, 'no current account'];\r\n\r\n        try {\r\n            const snapShots = await Promise.all(\r\n                tiles.map(tData => getDoc(doc(this._db, 'tiles', tData.tile._id)))\r\n            );\r\n\r\n            console.log('snapshots', snapShots);\r\n\r\n            const storedTiles = snapShots.map(t => tileFirebaseMapper({ ...t.data(), _id: t.id }));\r\n            // get parent tiles (if we buy not parent, but grouped tiles)\r\n            const parentTilesTupleIds = storedTiles.reduce<[ContractTileID, ContractTileID][]>(\r\n                (acc, tile) => {\r\n                    if (tile.boundedTiles.length && tile.boundedTiles[0] !== tile.id) {\r\n                        return [...acc, [tile.boundedTiles[0], tile.id]];\r\n                    }\r\n                    return [...acc];\r\n                }, []\r\n            );\r\n            const parentStoredTilesSnapshot = await Promise.all<[QuerySnapshot<DocumentData>, ContractTileID]>(\r\n                parentTilesTupleIds.map(([parenTileId, buyingTileId]) => {\r\n                    return new Promise(async (resolve, reject) => {\r\n                        try {\r\n                            const doc = await getDocs(query(\r\n                                this._tilesCollection, where('id', '==', '' + parenTileId))\r\n                            );\r\n                            resolve([doc, buyingTileId]);\r\n                        } catch (error) {\r\n                            reject(error);\r\n                        }\r\n                    });\r\n                })\r\n            );\r\n\r\n            const parentStoredTilesForUpd = parentStoredTilesSnapshot.map<null | [ContractTileInfo, ContractTileID]>(([t, buyingTileId]) => {\r\n                const docs = t.docs.map(doc => tileFirebaseMapper({ ...doc.data(), _id: doc.id }));\r\n                const tile = docs[0];\r\n                if (!tile.boundedTiles.find(x => x === buyingTileId)) return null;\r\n                return [docs[0], buyingTileId];\r\n            }).filter(t => !!t) as [ContractTileInfo, ContractTileID][];\r\n\r\n            console.log('parent store tiles: ', parentStoredTilesForUpd);\r\n\r\n            await Promise.all(\r\n                parentStoredTilesForUpd.map(([t, buyingTileId]) => updateDoc(\r\n                    doc(this._db, 'tiles', t._id),\r\n                    tileToFirebaseMapper({\r\n                        ...t,\r\n                        boundedTiles: t.boundedTiles.filter(x => x !== buyingTileId),\r\n                        version: t.version + 1\r\n                    })\r\n                ))\r\n            );\r\n\r\n            await Promise.all([\r\n                ...tiles.map((tileData, i) => {\r\n                    const storedTile = storedTiles.find(t => t._id === tileData.tile._id);\r\n                    if (!storedTile) return Promise.reject(`no tile found (# ${tileData.cellNumber})`);\r\n\r\n                    return updateDoc(\r\n                        doc(this._db, 'tiles', tileData.tile._id),\r\n                        tileToFirebaseMapper({ ...tileData.tile, title: formTileData.title || '', url: formTileData.url || '', owner: currAcc, boundedTiles: [], version: tileData.tile.version + 1 })\r\n                    )\r\n                }),\r\n                ...tiles.map(tile => {\r\n                    return updateDoc(\r\n                        doc(this._db, 'tokens', tile.token._id),\r\n                        tokenToFirebaseMapper({ ...tile.token, price: formTileData.price || tile.token.price })\r\n                    )\r\n                })\r\n            ]);\r\n\r\n            await this.fetchTiles();\r\n\r\n            return [true, ''];\r\n\r\n        } catch (error) {\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async mintTiles(tiles: IUnmintedTileState[], updatedTile: Partial<FormTileData>): Promise<[boolean, string]> {\r\n\r\n        console.log('mintTiles', tiles);\r\n\r\n        console.log('%c mint tiles ', 'background-color: orange; color: green', tiles);\r\n\r\n        const CURR_ADDR = this.getAccount();\r\n\r\n        if (!CURR_ADDR) {\r\n            return [false, 'no current account address'];\r\n        }\r\n\r\n        if (!tiles.length) {\r\n            return [false, 'no tiles for minting'];\r\n        }\r\n\r\n        try {\r\n            const result = await Promise.all(\r\n                tiles.map((tileData, i) =>\r\n                    addDoc(\r\n                        this._tokensCollection,\r\n                        tokenToFirebaseMapper({\r\n                            id: tileData.cellNumber as ContractTokenID,\r\n                            _id: undefined,\r\n                            owner: this.getAccount() || EMPTY_ADDR,\r\n                            price: updatedTile.price || '2.5'\r\n                        })\r\n                    )\r\n                )\r\n            );\r\n            console.log('mint result', result);\r\n            await Promise.all(\r\n                tiles.map((tileData, i) =>\r\n                    addDoc(\r\n                        this._tilesCollection,\r\n                        tileToFirebaseMapper({\r\n                            id: tileData.cellNumber as ContractTileID,\r\n                            _id: undefined,\r\n                            version: 0,\r\n                            boundedTiles: [],\r\n                            owner: this.getAccount() || EMPTY_ADDR,\r\n                            title: updatedTile.title || '',\r\n                            url: updatedTile.url || '',\r\n                            tokenId: tileData.cellNumber as ContractTokenID,\r\n                        })\r\n                    )\r\n                )\r\n            );\r\n            await this.fetchTiles();\r\n            return [true, ''];\r\n        } catch (error) {\r\n            throw error;\r\n        }\r\n    }\r\n}","import React, { useEffect, useMemo, useRef } from 'react';\r\nimport './App.scss';\r\n\r\nimport Header from './containers/Header';\r\n\r\nimport CellsLayout from './containers/CellsLayout';\r\n\r\nimport { appConfig } from './AppConfig';\r\n\r\nimport { CartEvents, ICartEventData, ICellData, ICellEventData, IUnmintedTileState, ITileState, MyCanvasMouseEvents, TilesEventCart } from './interfaces/cells';\r\n\r\nimport { BehaviorSubject } from 'rxjs/internal/BehaviorSubject';\r\nimport CartModal from './containers/Cart/CartModal';\r\nimport { Subject } from 'rxjs/internal/Subject';\r\nimport { CellEventTypes, CellsEvent } from './containers/CellsLayout/CellsLayout';\r\n\r\nimport ServiceContext from './contexts/ServiceContext';\r\nimport TestDataService from './services/TestDataService';\r\nimport { AccountAddr, ContractTileInfo, EMPTY_ADDR, FormTileData } from './services/interfaces';\r\n\r\nconst App = () => {\r\n\r\n    const cellSize: [number, number] = [appConfig.cellWidth, appConfig.cellHeight];\r\n    console.log('%c render global app! ', 'border: 2px solid red; color: silver; background-color: darkblue;');\r\n\r\n    const dataService = useMemo(() => new TestDataService(), []);\r\n\r\n    const currentAcc$ = useMemo(() => new BehaviorSubject<AccountAddr>(EMPTY_ADDR), []);\r\n\r\n    const cellEvent$ = useMemo(() => new BehaviorSubject<ICellEventData[]>([]), []);\r\n    const selectedCells$ = useMemo(() => new BehaviorSubject<ICellData[]>([]), []);\r\n    const selectedCellsRef = useRef<ICellData[]>([]);\r\n    const cartEvent$ = useMemo(() => new Subject<ICartEventData>(), []);\r\n    const cartState$ = useMemo(() => new Subject<TilesEventCart>(), []);\r\n    const cellsUpdate$ = useMemo(() => new Subject<CellsEvent>(), []);\r\n\r\n    useEffect(() => {\r\n        // 1.   load tiles  [ for every tile we have to load its Token ]\r\n        // 2.   start timer\r\n        // 3.   in every tick: load tiles\r\n        // 4.   find new tiles (compare timesatamps between current loaded tiles and state tiles)\r\n        // 5.   new\\updated tiles: send to eventBus (for displaying)\r\n        dataService.connect()\r\n            .then(isOk => {\r\n                const acc = dataService.getAccount();\r\n                acc && currentAcc$.next(acc);\r\n                dataService.fetchTiles().then(tiles => console.log('%c items loaded! ', 'color: green', [...tiles]));\r\n\r\n            })\r\n            .catch((err) => { });\r\n    }, [dataService, currentAcc$]);\r\n\r\n    useEffect(() => {\r\n        const sub = cellEvent$.subscribe((evArr) => {\r\n            const selected = evArr.filter(t => t.mouseType === MyCanvasMouseEvents.Click).map(t => t.curr);\r\n            const newCells: ICellData[] = [];\r\n            let evCells = [...selected];\r\n            const selectedState = [...selectedCellsRef.current];\r\n            selectedState.forEach(t => {\r\n                // store items of current stated cells if there are not in EV_CELLS\r\n                if (!evCells.find(x => x.cellNumber === t.cellNumber)) newCells.push(t);\r\n                // update EV_CELLS: only cells that are not stored (new)\r\n                evCells = evCells.filter(x => x.cellNumber !== t.cellNumber);\r\n            });\r\n            if (evCells.length || newCells.length) {\r\n                selectedCellsRef.current = [...selected];\r\n                selectedCells$.next([...selected]);\r\n            }\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [cellEvent$, selectedCells$, selectedCellsRef]);\r\n    useEffect(() => {\r\n        const sub = cartEvent$.subscribe((ev) => {\r\n            console.log('%c cartEvent ', 'border: 1px solid green', ev, dataService.getState());\r\n\r\n            const DATA_SERVICE_STATE = dataService.getState().getValue();\r\n\r\n            if (ev.type === CartEvents.Modify) {\r\n                cartState$.next({\r\n                    type: CartEvents.Modify,\r\n                    payload: DATA_SERVICE_STATE.tileCells.filter(t => {\r\n                        return cellEvent$.getValue().find(x =>\r\n                            x.mouseType === MyCanvasMouseEvents.Click\r\n                            && t.cellNumber === x.curr.cellNumber);\r\n                    }),\r\n                    groupUrl: ''\r\n                });\r\n            }\r\n            if (ev.type === CartEvents.Open) {\r\n                cartState$.next({\r\n                    type: CartEvents.Open,\r\n                    payload: cellEvent$.getValue()\r\n                        .filter(t => t.mouseType === MyCanvasMouseEvents.Click)\r\n                        .map<IUnmintedTileState>(t => {\r\n                            const tile = DATA_SERVICE_STATE.tileCells.find(x => x.cellNumber === t.curr.cellNumber);\r\n                            return {\r\n                                cellNumber: t.curr.cellNumber,\r\n                                point: t.curr.point,\r\n                                tile: tile && tile.tile,\r\n                                token: tile && tile.token\r\n                            }\r\n                        }),\r\n                    groupUrl: ''\r\n                });\r\n            }\r\n            if (ev.type === CartEvents.ShowOther) {\r\n                return cellsUpdate$.next([CellEventTypes.DisplayAll, []]);\r\n            }\r\n            if (ev.type === CartEvents.ShowOwn) {\r\n                const myAccount = dataService.getAccount();\r\n                console.log('my account: ', myAccount);\r\n                cellsUpdate$.next([\r\n                    CellEventTypes.DisplayOwnCells,\r\n                    dataService.getState().getValue().tileCells\r\n                        .filter(tileData => tileData.tile.owner === myAccount)\r\n                        .map<ICellEventData>(t => ({\r\n                            mouseType: MyCanvasMouseEvents.None,\r\n                            curr: { cellNumber: t.cellNumber, point: t.point },\r\n                            lastCell: { cellNumber: -1, point: [0, 0] }\r\n                        }))\r\n\r\n                ]);\r\n            }\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [dataService, cartEvent$, cartState$, cellEvent$, cellsUpdate$]);\r\n    useEffect(() => {\r\n        const sub = cartState$.subscribe((ev) => {\r\n            console.log('%c cartState ', 'border: 1px solid blue', ev);\r\n\r\n            // const DATA_SERVICE_STATE = dataService.getState().getValue();\r\n\r\n            if (ev.type === CartEvents.SaveTiles) {\r\n                // TASK: update TILE BOUNDS when regrouping!\r\n                const tiles = ev.payload.filter(t => !!t.tile && !!t.token);\r\n\r\n                if (tiles.length) dataService.groupTiles([...tiles] as ITileState[], ev.params || {});\r\n                // else {\r\n                //     cellsUpdate$.next([CellEventTypes.DisplayAll, []]);\r\n                //     dataService.mintTiles([...ev.payload] as IUnmintedTileState[], ev.groupUrl);\r\n                // }\r\n            }\r\n            if (ev.type === CartEvents.Buy) {\r\n                const tiles = ev.payload.filter(t => !!t.tile && !!t.token);\r\n\r\n                let tileData: Partial<FormTileData> = ev.params ? { ...ev.params } : {};\r\n                tileData.url = tileData.url || ev.groupUrl;\r\n\r\n                if (tiles.length) {\r\n                    cellsUpdate$.next([CellEventTypes.DisplayAll, []]);\r\n                    dataService.buyTiles([...tiles] as ITileState[], tileData);\r\n                } else {\r\n                    cellsUpdate$.next([CellEventTypes.DisplayAll, []]);\r\n                    dataService.mintTiles([...ev.payload] as IUnmintedTileState[], tileData);\r\n                }\r\n            }\r\n            if (ev.type === CartEvents.RemoveItems) {\r\n                const tiles = ev.payload.filter(t => !!t.tile && !!t.token);\r\n                cellsUpdate$.next([CellEventTypes.Remove, [...tiles] as ITileState[]]);\r\n            }\r\n            if (ev.type === CartEvents.Save) {\r\n                const tiles = ev.payload.filter(t => !!t.tile && !!t.token);\r\n                cellsUpdate$.next([CellEventTypes.UserUpdateTileGroup, [...tiles] as ITileState[]]);\r\n            }\r\n        });\r\n        return () => sub.unsubscribe();\r\n    }, [dataService, cellsUpdate$, cartState$, cellEvent$]);\r\n    return (\r\n        <div id=\"app-container\">\r\n            <ServiceContext.Provider value={ dataService }>\r\n                <Header event$={ cartEvent$ } selectedCells$={ selectedCells$ } />\r\n                <CellsLayout\r\n                    cellSize={ cellSize }\r\n                    currentAcc$={ currentAcc$ }\r\n                    cellsAmount={ appConfig.cellsAmount }\r\n                    cellBorderWidth={ appConfig.cellBorderWidth }\r\n                    maxCanvasWidth={ appConfig.maxCanvasWidth || 0 }\r\n                    event$={ cellEvent$ }\r\n                    cellsUpdate$={ cellsUpdate$ }\r\n                />\r\n                <CartModal event$={ cartState$ } />\r\n            </ServiceContext.Provider>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default App;\r\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.scss';\nimport App from './App';\n\nReactDOM.render(<App />, document.getElementById('root'));"],"sourceRoot":""}