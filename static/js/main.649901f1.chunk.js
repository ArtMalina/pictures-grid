(this["webpackJsonppictures-grid"]=this["webpackJsonppictures-grid"]||[]).push([[0],{47:function(e,t,n){},48:function(e,t,n){},62:function(e,t,n){"use strict";n.r(t);var r,c,l,i=n(4),o=n.n(i),u=n(39),a=n.n(u),s=(n(47),n(3)),b=n(5),d=(n(48),n(8)),f=n(41);!function(e){e[e.None=-1]="None",e[e.Move=0]="Move",e[e.Click=1]="Click"}(r||(r={})),function(e){e.None="<none>",e.Buy="<buy-cell>",e.Edit="<edit-cell>"}(c||(c={})),function(e){e.None="None",e.Open="Open",e.Close="Close",e.Save="Save",e.Buy="Buy",e.RemoveItems="RemoveItems",e.Modify="Modify",e.ShowOwn="ShowOwn",e.ShowOther="ShowOther",e.SaveTiles="SaveTiles"}(l||(l={}));var p=n(1),j=function(e){var t=e.title,n=e.event$,r=e.toggle,c=e.noActive,o=e.light,u=e.small,a=e.color,d=e.action,f=e.group,j=e.noBraces,m=e.fullWidth,h=e.textAlign,O=Object(i.useCallback)((function(e){e.stopPropagation(),e.preventDefault(),n&&n.next(d?Object(s.a)(Object(s.a)({},d),{},{group:f}):{type:l.Close,payload:[]})}),[n,d,f]),v=[m&&"full-width",h&&"align-".concat(h),c&&"no-action",o&&"light",u&&"small",a].filter(Boolean).map((function(e){return"btn--".concat(e)}));return 1===r&&v.push("btn--untoggled"),2===r&&v.push("btn--toggled"),f&&v.push("btn--grouped"),Object(p.jsxs)("div",{className:["btn"].concat(Object(b.a)(v)).join(" "),onClick:O,children:[!j&&Object(p.jsx)("div",{className:"btn_border btn_border--left"}),!!t&&Object(p.jsx)("div",{className:"btn-text",children:t||""}),e.children,!j&&Object(p.jsx)("div",{className:"btn_border btn_border--right"})]})},m=function(e){var t=e.event$,n=e.selectedCells$,r=Object(i.useMemo)((function(){return new f.a}),[]),c=Object(i.useState)([1,2]),o=Object(d.a)(c,2),u=o[0],a=o[1],s=Object(i.useRef)(u),m=Object(i.useState)([]),h=Object(d.a)(m,2),O=h[0],v=h[1];return Object(i.useEffect)((function(){var e=r.subscribe((function(e){if(console.log("%c filterBtn ev: ","background-color: brown; color: white;",e),console.log("downEv togglesStateRef.current",s.current),e.type===l.ShowOwn){if(e.group){var n=Object(d.a)(s.current,2),r=n[0],c=n[1];s.current=[1===r?2:1,1===c?2:1],a(s.current)}return t.next({type:1===s.current[0]?l.ShowOther:l.ShowOwn,payload:e.payload})}t.next(e)}));return function(){return e.unsubscribe()}}),[r,t,s]),Object(i.useEffect)((function(){var e=n.subscribe((function(e){console.log("%c selectedCells ev: ","background-color: brown; color: white;",e),v(Object(b.a)(e))}));return function(){return e.unsubscribe()}}),[n]),Object(p.jsx)("header",{children:Object(p.jsxs)("div",{className:"header_content",children:[Object(p.jsx)("div",{className:"flex-cnt align-center mx-4",children:Object(p.jsx)(j,{light:!0,color:"header",title:"Hello, crypto man"})}),Object(p.jsx)("div",{style:{backgroundColor:"white",padding:"0 10px"}}),Object(p.jsxs)("div",{className:"flex-cnt align-center",children:[Object(p.jsx)("div",{className:"flex-cnt item fb-3",children:Object(p.jsxs)(j,{light:!0,small:!0,color:"primary",title:"TILES",event$:r,action:{type:l.ShowOwn,payload:[]},group:1,children:[Object(p.jsx)(j,{event$:r,action:{type:l.ShowOwn,payload:[]},light:!0,small:!0,noBraces:!0,group:1,toggle:u[0],color:"primary",title:"MY"}),Object(p.jsx)(j,{event$:r,action:{type:l.ShowOwn,payload:[]},light:!0,small:!0,noBraces:!0,group:2,toggle:u[1],color:"primary",title:"FOR SALE"})]})}),Object(p.jsxs)("div",{className:"flex-cnt justify-end",style:{width:250},children:[Object(p.jsx)("div",{className:"flex-cnt item shrink mx-3",children:Object(p.jsx)(j,{event$:t,action:{type:1===u[0]?l.Open:l.Modify,payload:[]},light:!0,color:"info",title:1===u[0]?"Buy":"Modify"})}),Object(p.jsx)("div",{className:"flex-cnt item shrink badge-cnt",children:!!O.length&&Object(p.jsx)("div",{className:"badge badge--info",children:1===u[0]?"!":O.length})})]})]})]})})},h=n(6),O=n(18),v=n(17),y=o.a.createContext(null),g=function(e){var t=e.width,n=e.height,c=e.event$,l=e.canvas2dCtxInList$,o=Object(i.useCallback)((function(e){c.next([r.Click,e])}),[c]),u=Object(i.useCallback)((function(e){c.next([r.Move,e])}),[c]),a=Object(i.useCallback)((function(e){if(e&&!l.getValue().length){var t=e.getContext("2d");t&&l.next([t])}}),[l]);return Object(p.jsx)("div",{id:"canvas-container",style:{width:t,height:n},children:Object(p.jsx)("canvas",{id:"canvas",onClick:o,onMouseMove:u,onMouseLeave:u,width:t,height:n,ref:a})})},x={inRowCells:0,cellsAmount:500,cellWidth:50,cellHeight:50,cellBorderWidth:2,maxCanvasWidth:1350};function N(e){var t=Math.floor(e/x.inRowCells);return[e-x.inRowCells*t,t]}x.inRowCells=Math.floor((x.maxCanvasWidth-x.cellBorderWidth)/(x.cellWidth+x.cellBorderWidth));var C,w=function(e,t){return t.reduce((function(t,n){return!t[0]&&!t[1]||t[e]>n[e]?[n[0],n[1]]:t}),[0,0])},T=function(e,t){return t.reduce((function(t,n){return!t[0]&&!t[1]||t[e]<n[e]?[n[0],n[1]]:t}),[0,0])},k=["#212529","#23272c","#22262b","#23282e","#25292e"];!function(e){e.BASE="#000000",e.HOVERED="yellow",e.SELECTED="orange",e.HOVER_SELECTED="#69f0ae",e.SHOW_FILTERED_TILES="silver"}(C||(C={}));var S,E=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return function(i){return[i[0]*e+n,i[1]*t+r,i[2]*e-c,i[3]*t-l]}},M=function(e,t,n,r,c,l){var i=Object(d.a)(t,1)[0],o=.5*l,u=.5*l;Array.from(new Array(n)).forEach((function(t,n){var a=l;u+r>i&&(u=.5*l,o+=c+l),function(t,n,i){(function(e,t,n,r){var c=Object(d.a)(t,4),l=c[0],i=c[1],o=c[2],u=c[3];e.beginPath(),e.fillStyle=k[Math.floor(5*Math.random())],e.rect(l,i,o+n,u+n),e.fill(),e.lineWidth=n,e.strokeStyle=C.BASE,e.stroke(),e.font="italic 12pt Arial",e.fillStyle="#4fc3f7",e.fillText("".concat(r.cellNumber.toString()),Math.round(l+.1*o),Math.round(i+.5*u-5))})(e,[n,i,r,c],l,{cellNumber:t+1,point:[-1,-1]})}(n,u,o),u+=r+a}))},_=function(e,t,n,r,c,l){var i=Object(d.a)(t.point,2),o=i[0],u=i[1],a=Object(d.a)(r,2),s=a[0],b=a[1],f=.5*c+(s+c)*o,p=.5*c+(b+c)*u;e.beginPath(),e.rect(f,p,s+c,b+c),e.lineWidth=c,e.strokeStyle=l,e.stroke()},A=function(e,t,n,r,c){var l,i=Object(d.a)(r,2),o=i[0],u=i[1],a={left:w(0,l=n),top:w(1,l),right:T(0,l),bottom:T(1,l)},s=a.left,b=a.bottom,f=a.top,p=a.right[0]-s[0]+1,j=b[1]-f[1]+1,m=E(t.width/p,t.height/j,-s[0]*t.width/p,-f[1]*t.height/j,1/p,1/j),h=E(o,u,1,1,0,0);n.forEach((function(n){var r=m([n[0],n[1],1,1]),l=Object(d.a)(r,4),i=l[0],o=l[1],u=l[2],a=l[3],s=h([n[0],n[1],1,1]),b=Object(d.a)(s,4),f=b[0],p=b[1],j=b[2],O=b[3],v=.5*c+c*n[0],y=.5*c+c*n[1];e.drawImage(t,i,o,u,a,f+v,p+y,j,O)}))},B=function(e){var t=e.cellW,n=e.cellH,c=e.cellBorderWidth,l=e.amount,o=e.canvas2dCtxInList$,u=e.event$,a=e.canvasSize;return Object(i.useEffect)((function(){console.log("%c render cells Grid! ","border: 1px solid orange;",a);var e=o.subscribe((function(e){e.forEach((function(e){M(e,a,l,t,n,c)}))}));return function(){return e.unsubscribe()}}),[t,n,c,l,a,o]),Object(i.useEffect)((function(){var e=u.subscribe((function(e){var l=e.displayCells,i=e.clearCells,u=e.displayTiles,a=(e.clearTiles,e.highlightCells);o.getValue().forEach((function(e){var o={},s={},b=[];u.forEach((function(r){!function(e,t,n,r,c){var l=Object(d.a)(r,2),i=l[0],o=l[1],u=Object(d.a)(t.point,2),a=u[0],s=u[1],b=c+(i+c)*a,f=c+(o+c)*s;if(e.beginPath(),e.fillStyle="#37474f",e.rect(b,f,i,o),e.fill(),t.tile.url){var p=new Image;p.onload=function(){t.tile.boundedTiles.length&&t.tile.boundedTiles[0]===t.tile.id?A(e,p,t.tile.boundedTiles.map((function(e){return N(e)})),[i,o],c):(e.beginPath(),e.rect(b,f,i,o),e.fillStyle="#37474f",e.fill(),e.drawImage(p,b,f,i,o))},p.src=t.tile.url}}(e,r,0,[t,n],c)})),i.forEach((function(i){var u=i.cellNumber,a=i.point,s=l.filter((function(e){return e.mouseType===r.Click&&e.cellNumber===u}));o[u]=1,s.length||_(e,{cellNumber:u,point:a},0,[t,n],c,C.BASE)})),a.forEach((function(r){var l=r.cellNumber,i=r.point;_(e,{cellNumber:l,point:i},0,[t,n],c,C.SHOW_FILTERED_TILES)})),l.forEach((function(l){var i=l.cellNumber,o=l.mouseType,u=l.point,a=o===r.Click?C.SELECTED:C.HOVERED;s[i]?b.push(l):_(e,{cellNumber:i,point:u},0,[t,n],c,a),o===r.Click&&(s[i]=2),o===r.Move&&(s[i]=1)})),b.forEach((function(r){var l=r.cellNumber,i=r.point;_(e,{cellNumber:l,point:i},0,[t,n],c,C.HOVER_SELECTED)}))}))}));return function(){return e.unsubscribe()}}),[u,o,t,n,c,a]),null};!function(e){e[e.None=0]="None",e[e.Add=1]="Add",e[e.Remove=2]="Remove",e[e.UpdateByContract=3]="UpdateByContract",e[e.DisplayOwnCells=4]="DisplayOwnCells",e[e.DisplayOtherCells=5]="DisplayOtherCells",e[e.DisplayAll=6]="DisplayAll",e[e.UserUpdateTileGroup=7]="UserUpdateTileGroup"}(S||(S={}));var I,$=function(e,t,n){return{cellNumber:e.curr.cellNumber,point:e.curr.point,mouseType:e.mouseType}},R=function(e){var t=e.cellSize,n=e.cellsAmount,l=e.cellBorderWidth,o=e.maxCanvasWidth,u=e.event$,a=e.cellsUpdate$,f=e.currentAcc$,j=Object(i.useRef)(c.Buy),m=Object(i.useContext)(y),x=Object(d.a)(t,2),N=x[0],C=x[1],w=Object(i.useState)([0,0,!1]),T=Object(d.a)(w,2),k=T[0],E=T[1],M=Object(i.useRef)(null),_=Object(i.useRef)([0,0]),A=Object(i.useRef)([0,0]),I=Object(i.useRef)([]),R=Object(i.useRef)({}),D=Object(i.useMemo)((function(){return new O.BehaviorSubject([])}),[]),W=Object(i.useMemo)((function(){return new v.Subject}),[]),U=Object(i.useMemo)((function(){return new O.BehaviorSubject({displayCells:[],clearCells:[],displayTiles:[],clearTiles:[],highlightCells:[],shadeCells:[]})}),[]),L=Object(i.useMemo)((function(){return new O.BehaviorSubject({})}),[]),V=Object(i.useState)([!1,null]),P=Object(d.a)(V,2),H=(P[0],P[1],Object(i.useCallback)((function(e){if(e){var t=N,r=o,c=Math.floor((r-l)/(t+l)),i=(c+1)*l+c*t,u=Math.ceil(n/c),a=u*C+u*l+l;M.current=e,A.current=[c,u],_.current=[i,a],E([i,a,!0])}}),[M,_,A,n,l,o,N,C]));return Object(i.useEffect)((function(){var e=m.getState().subscribe((function(e){console.log("new state",Object(s.a)({},e));var t=u.getValue(),n=R.current,l=t.reduce((function(e,t,n){return Object(s.a)(Object(s.a)({},e),{},Object(h.a)({},t.curr.cellNumber,n))}),{}),i={},o=!1,d=[];e.tileCells.forEach((function(r){i[r.cellNumber]=[e.lastUpdate,Object(s.a)({},r)],(!n[r.cellNumber]||n[r.cellNumber]<r.tile.version+1)&&(console.log("tile",r,l,Object(b.a)(t)),console.log("contractTilesData:cellNumber",r.cellNumber,r.tile.version,i[r.cellNumber]),n[r.cellNumber]=r.tile.version+1,d.push(Object(s.a)({},r)),l[r.cellNumber]>0&&(o=!0))})),o&&a.next([S.UpdateByContract,Object(b.a)(t)]),L.next(Object(s.a)({},i));var f=[];j.current===c.Edit&&(f=e.tileCells.filter((function(e){return e.tile&&e.tile.owner===m.getAccount()})).map((function(e){return{cellNumber:e.cellNumber,mouseType:r.None,point:e.point}})),I.current=Object(b.a)(f)),U.next({displayCells:[],clearCells:[],displayTiles:[].concat(d),clearTiles:[],highlightCells:Object(b.a)(f),shadeCells:[]})}));return function(){return e.unsubscribe()}}),[m,U,u,I,a,L,R,j]),Object(i.useEffect)((function(){var e=a.subscribe((function(e){var t=e[0],n=e[1];console.log("cellsUpdate$",t,n);var l=u.getValue();if(t===S.DisplayAll||t===S.DisplayOwnCells){var i=t===S.DisplayAll?Object(b.a)(I.current):[];j.current=t===S.DisplayAll?c.Buy:c.Edit,I.current=e[1].map((function(e){return{cellNumber:e.curr.cellNumber,point:e.curr.point,mouseType:r.None}}));var o=l.filter((function(e){return e.mouseType===r.Click&&i.findIndex((function(t){return t.cellNumber===e.curr.cellNumber}))<0})).map((function(e){return{cellNumber:e.curr.cellNumber,point:e.curr.point,mouseType:e.mouseType}}));return u.next(l.filter((function(e){return e.mouseType!==r.Click}))),U.next({displayCells:[],clearCells:[].concat(Object(b.a)(i),Object(b.a)(o)),displayTiles:[],clearTiles:[],highlightCells:Object(b.a)(I.current),shadeCells:[]})}if(t!==S.UpdateByContract&&t===S.Remove){var a=l.filter((function(t){return t.mouseType!==r.Click||e[1].findIndex((function(e){return e.cellNumber===t.curr.cellNumber}))<0}));return u.next(Object(b.a)(a)),void U.next({displayCells:a.filter((function(e){return e.mouseType===r.Click})).map($),clearCells:e[1].map((function(e){return{cellNumber:e.cellNumber,point:e.point,mouseType:r.Click}})),displayTiles:[],clearTiles:[],highlightCells:[],shadeCells:[]})}}));return function(){return e.unsubscribe()}}),[a,u,U,j,I]),Object(i.useEffect)((function(){var e=W.subscribe((function(e){var t=Object(d.a)(e,2),n=t[0],i=t[1],o=i.clientX,a=i.clientY,p=i.currentTarget,m=p.offsetLeft,h=p.offsetTop,O=M.current?[M.current.scrollLeft,M.current.scrollTop]:[0,0],v=Object(d.a)(O,2),y=v[0],g=v[1],x=u.getValue();if(o-m+y+l>=_.current[0]||o<=m||a<=h||a-h+g+l>=_.current[1]){var w=x.filter((function(e){return e.mouseType!==r.Move}));return U.next({displayCells:w.map($),clearCells:x.filter((function(e){return e.mouseType===r.Move&&I.current.findIndex((function(t){return t.cellNumber===e.curr.cellNumber}))<0})).map($),displayTiles:[],clearTiles:[],highlightCells:Object(b.a)(I.current),shadeCells:[]}),void u.next(Object(b.a)(w))}var T=function(e,t,n){var r=n.inRowCount,c=n.cellW,l=n.cellH,i=Math.floor(e/c),o=Math.floor(t/l);return{cellNumber:o*r+i,x:i,y:o,w:c,h:l}}(o+y-m,a+g-h,{inRowCount:A.current[0],cellW:N+l,cellH:C+l}),k={cellNumber:T.cellNumber,point:[T.x,T.y]};if(n!==r.Move||!x.find((function(e){return e.mouseType===n&&e.curr.cellNumber===T.cellNumber}))){var S=j.current,E=f.getValue(),B=L.getValue(),R=n===r.Click,D=x.length&&n===r.Move,W=S===c.Edit&&R&&(!B[k.cellNumber]||B[k.cellNumber][1].tile.owner!==E);W&&(R=!1);var V={display:x.length||W?[]:[Object(s.a)(Object(s.a)({},k),{},{mouseType:n})],clear:[],finalCellEvents:x.length||W?[]:[{mouseType:n,lastCell:{cellNumber:-1,point:[0,0]},curr:Object(s.a)({},k)}]};if(x.forEach((function(e){if(n===r.Click){if(S===c.Edit&&e.mouseType===r.Click&&(!B[e.curr.cellNumber]||B[e.curr.cellNumber][1].tile.owner!==E))return void(R=!1);if(S!==c.Edit||e.mouseType!==r.Click||W||e.curr.cellNumber!==k.cellNumber&&V.display.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:e.mouseType})),S===c.Buy&&e.mouseType===r.Click&&B[e.curr.cellNumber]&&B[e.curr.cellNumber][1].tile.owner===E)return;if(S===c.Buy&&e.curr.cellNumber!==k.cellNumber)return void V.clear.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:n}));if(e.curr.cellNumber===k.cellNumber&&e.mouseType===n)return R=!1,void V.clear.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:n}));e.curr.cellNumber===k.cellNumber&&e.mouseType!==n&&V.display.push(Object(s.a)(Object(s.a)({},k),{},{mouseType:r.Move})),V.finalCellEvents.push(Object(s.a)({},e))}if(n===r.Move){if(e.mouseType===n&&e.curr.cellNumber===k.cellNumber)return D=!1,void V.finalCellEvents.push(Object(s.a)({},e));if(e.curr.cellNumber===k.cellNumber&&e.mouseType===r.Click)return V.finalCellEvents.push(Object(s.a)({},e)),void V.display.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:e.mouseType}));if(e.mouseType===n&&e.curr.cellNumber!==k.cellNumber)return D=!1,V.clear.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:n})),V.finalCellEvents.push({mouseType:e.mouseType,lastCell:Object(s.a)({},e.curr),curr:Object(s.a)({},k)}),void V.display.push(Object(s.a)(Object(s.a)({},k),{},{mouseType:n}));V.finalCellEvents.push(Object(s.a)({},e)),V.display.push(Object(s.a)(Object(s.a)({},e.curr),{},{mouseType:e.mouseType}))}})),D&&(V.finalCellEvents.push({mouseType:n,lastCell:{cellNumber:-1,point:[0,0]},curr:Object(s.a)({},k)}),V.display.push(Object(s.a)(Object(s.a)({},k),{},{mouseType:n}))),R){if(S===c.Buy&&B[k.cellNumber]&&B[k.cellNumber][1].tile.owner===E)return;V.finalCellEvents.push({mouseType:n,lastCell:{cellNumber:-1,point:[0,0]},curr:Object(s.a)({},k)}),V.display.push(Object(s.a)(Object(s.a)({},k),{},{mouseType:n}))}n===r.Click&&(W&&(V.finalCellEvents=V.finalCellEvents.filter((function(e){return e.mouseType!==r.Click}))),console.log("final res",R,Object(s.a)({},V))),(V.display.length||V.clear.length)&&U.next({displayCells:Object(b.a)(V.display),clearCells:V.clear.filter((function(e){return I.current.findIndex((function(t){return t.cellNumber===e.cellNumber}))<0})),displayTiles:[],clearTiles:[],highlightCells:I.current.filter((function(e){return V.display.findIndex((function(t){return t.cellNumber===e.cellNumber}))<0})),shadeCells:[]}),n===r.Click&&console.log("\nresult",Object(s.a)({},V)),u.next(Object(b.a)(V.finalCellEvents))}}));return function(){return e.unsubscribe()}}),[M,_,A,u,j,L,f,U,W,I,l,N,C]),Object(p.jsxs)("div",{id:"cells-body",className:"overflow",ref:H,children:[Object(p.jsx)(g,{width:k[0],height:k[1],canvas2dCtxInList$:D,event$:W}),k[0]&&k[1]&&Object(p.jsx)(B,{event$:U,canvas2dCtxInList$:D,amount:n,cellW:t[0],cellH:t[1],cellBorderWidth:l,canvasSize:[k[0],k[1]]})]})},D=n(63),W=function(e){var t=e.value,n=e.event$,r=e.noActive,c=e.light,l=e.small,o=e.color,u=e.action,a=Object(i.useState)(t||""),s=Object(d.a)(a,2),f=s[0],j=s[1],m=Object(i.useCallback)((function(e){j(e.currentTarget.value),n&&n.next([e.currentTarget.value,u])}),[n,u]),h=[r&&"no-action",c&&"light",l&&"small",o].filter(Boolean).map((function(e){return"text-input--".concat(e)}));return Object(p.jsx)("div",{className:["text-input"].concat(Object(b.a)(h)).join(" "),children:Object(p.jsx)("input",{type:"text",value:f,onChange:m,disabled:r})})},U=function(e){var t=e.title,n=e.width,r=e.height,c=e.event$,o=e.open,u=Object(i.useState)({type:l.Close,payload:[],groupUrl:""}),a=Object(d.a)(u,2),s=a[0],b=a[1];if(Object(i.useEffect)((function(){console.log("useEffect in modal....");var e=c.subscribe((function(e){console.log("ev in modal: ",e),[l.Modify,l.Open].includes(e.type)&&b(e)}));return function(){return e.unsubscribe()}}),[c]),console.log("Modal state",s),!o)return null;var f=!!s.payload.filter((function(e){return!e.token&&!e.tile})).length,m=s&&s.type===l.Modify?"Save":"Buy";m=s&&s.type===l.Open?"Buy":m,m=f?"Mint":m;var h=s&&s.type===l.Open||f?l.Buy:l.Save;return Object(p.jsx)("div",{id:"modal-overlay-cnt",children:Object(p.jsxs)("div",{id:"modal-cnt",style:{width:n,height:r,top:"25%",marginLeft:-.5*n},children:[Object(p.jsxs)("div",{className:"header",children:[Object(p.jsx)(j,{light:!0,color:"header",noActive:!0,title:t}),Object(p.jsxs)("div",{className:"flex-cnt",children:[Object(p.jsx)(j,{event$:c,action:{type:h,payload:[]},light:!0,color:"active",title:m}),Object(p.jsx)("div",{className:"flex-cnt item mx-1"}),Object(p.jsx)(j,{event$:c,action:{type:l.Close,payload:[]},light:!0,color:"close",title:"Close"})]})]}),Object(p.jsx)("div",{className:"content",children:e.children}),Object(p.jsx)("div",{className:"footer"})]})})};!function(e){e[e.None=0]="None",e[e.BuyCellsMode=1]="BuyCellsMode",e[e.ModifyCellsMode=2]="ModifyCellsMode"}(I||(I={}));var L=function(e){var t=e.event$,n=Object(i.useMemo)((function(){return new v.Subject}),[]),r=Object(i.useMemo)((function(){return new v.Subject}),[]),c=Object(i.useMemo)((function(){return new v.Subject}),[]),o=Object(i.useState)([I.None,[]]),u=Object(d.a)(o,2),a=u[0],f=u[1],m=Object(i.useRef)([]),h=a[1].reduce((function(e,t){return t.tile?e&&t.tile.url?"":t.tile.url||e:e}),""),O=Object(i.useMemo)((function(){return new D.a([h||"",null])}),[h]),y=Object(i.useRef)({});return Object(i.useEffect)((function(){var e=O.subscribe((function(e){var t=Object(d.a)(e,2),n=t[0],r=t[1];r&&(y.current[r]=n)}));return function(){return e.unsubscribe()}}),[O,y]),Object(i.useEffect)((function(){var e=t.subscribe((function(e){console.log("%c event$ in cart-modal: ","border: 1px solid green",e,O.getValue()),e.type!==l.Modify&&e.type!==l.Open||(O.next(["",null]),m.current=Object(b.a)(e.payload),f([e.type===l.Modify?I.ModifyCellsMode:I.BuyCellsMode,Object(b.a)(e.payload)]),c.next(e))})),n=c.subscribe((function(e){console.log("cart event",e,Object(b.a)(m.current)),[l.Close,l.Save,l.Buy].includes(e.type)&&(e.type===l.Buy?m.current.length&&t.next({type:l.Buy,params:y.current&&Object(s.a)({},y.current),payload:m.current.map((function(e){return Object(s.a)({},e)})),groupUrl:O.getValue()[0]}):e.type===l.Save&&(m.current.length?t.next({type:l.SaveTiles,payload:Object(b.a)(m.current),groupUrl:O.getValue()[0]}):t.next(e)),m.current=[],O.next(["",null]),f([I.None,[]])),e.type===l.RemoveItems&&(m.current=m.current.filter((function(t){return e.payload.findIndex((function(e){return e.cellNumber===t.cellNumber}))<0})),f([I.ModifyCellsMode,Object(b.a)(m.current)]),t.next(e))}));return function(){e.unsubscribe(),n.unsubscribe()}}),[t,n,m,O,y]),Object(i.useEffect)((function(){var e=r.subscribe((function(e){console.log("remove >",e),c.next({type:l.RemoveItems,payload:[Object(s.a)({},e)],groupUrl:""})}));return function(){return e.unsubscribe()}}),[t,r]),console.log("state CartModal: ",a),Object(p.jsx)("div",{children:Object(p.jsx)(U,{title:"Crypto tiles",width:770,height:450,event$:c,open:a[0]!==I.None,children:Object(p.jsxs)("div",{className:"flex-cnt item wrap content-start overflow px-2",children:[a[0]===I.ModifyCellsMode&&Object(p.jsxs)("div",{className:"flex-cnt item wrap fb-10 px-2 my-2",children:[Object(p.jsx)(j,{color:"secondary",noActive:!0,title:a[1].length>1?"group url":"url",small:!0}),Object(p.jsx)(W,{event$:O,value:h})]}),Object(p.jsxs)("div",{className:"flex-cnt item justify-start fb-10 wrap px-2 py-3",children:[a[0]===I.ModifyCellsMode&&a[1].length>1&&Object(p.jsx)("div",{className:"flex-cnt item fb-10 my-2",children:Object(p.jsx)(j,{color:"secondary",noActive:!0,title:"group tiles",small:!0})}),a[0]===I.ModifyCellsMode&&a[1].map((function(e){return Object(p.jsxs)("div",{className:"flex-cnt item wrap fb-2 align-center shrink mx-1 px-3 py-1",style:{marginBottom:8,backgroundColor:"white"},children:[Object(p.jsx)("div",{className:"flex-cnt item fb-4 modal_cell-item",children:e.cellNumber+1}),Object(p.jsx)("div",{className:"flex-cnt item fb-3 justify-end",children:Object(p.jsx)(j,{action:e,light:!0,color:"error",title:"X",small:!0,event$:r})})]},e.cellNumber)})),a[0]===I.BuyCellsMode&&Object(p.jsx)("div",{className:"flex-cnt item wrap justify-start fb-10",children:a[1].map((function(e){return Object(p.jsxs)("div",{className:"flex-cnt item wrap fb-10 align-center shrink mx-1 px-3 py-1",style:{marginBottom:8,backgroundColor:"white"},children:[Object(p.jsx)("div",{className:"flex-cnt item fb-4 shrink",children:Object(p.jsx)(j,{color:"header",textAlign:"left",noActive:!0,title:"price (Eth)",small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item justify-end fb-4",children:Object(p.jsx)(j,{color:"info",noActive:!0,title:"# ".concat(e.cellNumber+1),small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item shrink fb-10 mt-1 mb-4",children:Object(p.jsx)(W,{color:"header",event$:O,action:"price",value:e.token?""+e.token.price:""})}),Object(p.jsx)("div",{className:"flex-cnt item fb-4 shrink",children:Object(p.jsx)(j,{color:"close",textAlign:"left",noActive:!0,title:"image url",small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item fb-10 mt-1 mb-4",children:Object(p.jsx)(W,{event$:O,action:"url",value:e.tile&&e.tile.url||""})}),Object(p.jsx)("div",{className:"flex-cnt item fb-4 shrink",children:Object(p.jsx)(j,{color:"close",textAlign:"left",noActive:!0,title:"title",small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item shrink fb-10 mt-1 mb-4",children:Object(p.jsx)(W,{event$:O,action:"title",color:"header",value:e.tile?""+e.tile.title:""})}),Object(p.jsx)("div",{className:"flex-cnt item fb-4 shrink",children:Object(p.jsx)(j,{color:"close",textAlign:"left",noActive:!0,title:"bounded tiles",small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item shrink fb-10 wrap",children:e.tile&&e.tile.boundedTiles.map((function(e){return Object(p.jsx)("div",{className:"flex-cnt item shrink my-1 mx-2",children:Object(p.jsx)(j,{color:"base",noActive:!0,title:e.toString(),small:!0})},e.toString())}))}),Object(p.jsx)("div",{className:"flex-cnt item fb-4 mt-4 shrink",children:Object(p.jsx)(j,{color:"close",textAlign:"center",noActive:!0,title:"owner address",small:!0})}),Object(p.jsx)("div",{className:"flex-cnt item shrink fb-10 mt-1 mb-4",children:Object(p.jsx)(W,{noActive:!0,color:"header",value:e.tile?""+e.tile.owner:""})})]},e.cellNumber)}))})]})]})})})},V=n(7),P=n.n(V),H=n(14),z=n(0),G=n(2),F=n(40),X=n(12),Y={apiKey:"AIzaSyD8Ad1yitALcRL8lBafsDVB3cqWXl4r0hY",authDomain:"tiles-c734c.firebaseapp.com",projectId:"tiles-c734c",storageBucket:"tiles-c734c.appspot.com",messagingSenderId:"895094851367",appId:"1:895094851367:web:e231bfb9953e7edc350b02"},J="<no-account>",q=function(e,t){return{tile:e,token:t,cellNumber:e.id,point:N(e.id)}},K={_id:1,id:-1,owner:J,price:"",url:""},Q=function(e){var t=e._id?{_id:e._id}:{};return Object(s.a)(Object(s.a)({},t),{},{id:""+e.id,owner:e.owner,tokenId:""+e.tokenId,title:e.title,url:e.url,version:e.version||0,boundedTiles:e.boundedTiles?e.boundedTiles.map((function(e){return""+e})).join(","):""})},Z=function(e){return{_id:e._id,version:e.version||0,id:Number(e.id),owner:e.owner,tokenId:Number(e.tokenId),title:e.title,url:e.url,boundedTiles:e.boundedTiles?(""+e.boundedTiles).split(",").map((function(e){return Number(e)})):[]}},ee=function(e){return{_id:e._id,id:Number(e.id),owner:"",price:e.price,url:""}},te=function(e){var t=e._id?{_id:e._id}:{};return Object(s.a)(Object(s.a)({},t),{},{id:Number(e.id),owner:"",price:e.price,url:""})},ne=function(){function e(){Object(z.a)(this,e),this._account=null,this._state=new O.BehaviorSubject({lastUpdate:0,tileCells:[]}),this._firebaseApp=void 0,this._db=void 0,this._tilesCollection=void 0,this._tokensCollection=void 0,this._firebaseApp=Object(F.a)(Y),this._db=Object(X.f)(this._firebaseApp),this._tilesCollection=Object(X.b)(this._db,"tiles"),this._tokensCollection=Object(X.b)(this._db,"tokens")}return Object(G.a)(e,[{key:"getState",value:function(){return this._state}},{key:"connect",value:function(){return this._account="test-owner-1",new Promise((function(e){return setTimeout((function(){return e(!0)}),2e3)}))}},{key:"getAccount",value:function(){return this._account}},{key:"getTileInfo",value:function(){var e=Object(H.a)(P.a.mark((function e(t){var n;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(X.d)(Object(X.c)(this._db,"tiles",""+t));case 3:return n=e.sent,e.abrupt("return",Z(Object(s.a)(Object(s.a)({},n.data()),{},{_id:n.id})));case 7:throw e.prev=7,e.t0=e.catch(0),e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTokenInfo",value:function(){var e=Object(H.a)(P.a.mark((function e(t){var n;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(X.d)(Object(X.c)(this._db,"tokens",""+t));case 3:return n=e.sent,e.abrupt("return",ee(Object(s.a)(Object(s.a)({},n.data()),{},{_id:n.id})));case 7:throw e.prev=7,e.t0=e.catch(0),e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTokensByIds",value:function(){var e=Object(H.a)(P.a.mark((function e(t){var n=this;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all(t.map((function(e){return n.fetchTokenInfo(e)}))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTiles",value:function(){var e=Object(H.a)(P.a.mark((function e(){var t,n,r,c,l,i;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all([Object(X.e)(this._tilesCollection),Object(X.e)(this._tokensCollection)]);case 3:return t=e.sent,n=Object(d.a)(t,2),r=n[0],c=n[1],l=r.docs.map((function(e){return Object(s.a)(Object(s.a)({},e.data()),{},{_id:e.id})})).map(Z),i=c.docs.map((function(e){return Object(s.a)(Object(s.a)({},e.data()),{},{_id:e.id})})).map(ee),console.log("%c tiles, tokens: ","border: 1px solid blue",r.docs,c.docs.map((function(e){return e.data()}))),this._state.next({lastUpdate:(new Date).getTime(),tileCells:l.map((function(e){var t=i.find((function(t){return t.id===e.tokenId}));return q(e,t||K)}))}),e.abrupt("return",Object(b.a)(l));case 14:throw e.prev=14,e.t0=e.catch(0),console.log("error with loading docs from collections: ",e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[0,14]])})));return function(){return e.apply(this,arguments)}}()},{key:"groupTiles",value:function(){var e=Object(H.a)(P.a.mark((function e(t,n){var r,c=this;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.sort((function(e,t){return e.cellNumber>t.cellNumber?1:-1})),console.log("%c group tiles ","background-color: orange; color: green",t,Object(b.a)(r)),t.length){e.next=4;break}return e.abrupt("return",[!1,"no tiles for grouping"]);case 4:return e.prev=4,e.next=7,Promise.all(r.map((function(e,t){var l=n&&!t?Object(b.a)(r.map((function(e){return e.tile.id}))):[],i=n&&t?[r[0].tile.id]:[];return Object(X.h)(Object(X.c)(c._db,"tiles",e.tile._id),Q(Object(s.a)(Object(s.a)({},e.tile),{},{url:t?"":n,version:e.tile.version+1,boundedTiles:t?[].concat(i):Object(b.a)(l)})))})));case 7:return e.next=9,this.fetchTiles();case 9:return e.abrupt("return",[!0,""]);case 12:throw e.prev=12,e.t0=e.catch(4),e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"buyTiles",value:function(){var e=Object(H.a)(P.a.mark((function e(t,n){var r,c,l,i,o,u,a=this;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("%c buy tiles ","background-color: orange; color: darkcyan",t),t.length){e.next=3;break}return e.abrupt("return",[!1,"no tiles for buying"]);case 3:if(r=this.getAccount()){e.next=6;break}return e.abrupt("return",[!1,"no current account"]);case 6:return e.prev=6,e.next=9,Promise.all(t.map((function(e){return Object(X.d)(Object(X.c)(a._db,"tiles",e.tile._id))})));case 9:return c=e.sent,console.log("snapshots",c),l=c.map((function(e){return Z(Object(s.a)(Object(s.a)({},e.data()),{},{_id:e.id}))})),i=l.reduce((function(e,t){return t.boundedTiles.length&&t.boundedTiles[0]!==t.id?[].concat(Object(b.a)(e),[[t.boundedTiles[0],t.id]]):Object(b.a)(e)}),[]),e.next=15,Promise.all(i.map((function(e){var t=Object(d.a)(e,2),n=t[0],r=t[1];return new Promise(function(){var e=Object(H.a)(P.a.mark((function e(t,c){var l;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(X.e)(Object(X.g)(a._tilesCollection,Object(X.i)("id","==",""+n)));case 3:l=e.sent,t([l,r]),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),c(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}())})));case 15:return o=e.sent,u=o.map((function(e){var t=Object(d.a)(e,2),n=t[0],r=t[1],c=n.docs.map((function(e){return Z(Object(s.a)(Object(s.a)({},e.data()),{},{_id:e.id}))}));return c[0].boundedTiles.find((function(e){return e===r}))?[c[0],r]:null})).filter((function(e){return!!e})),console.log("parent store tiles: ",u),e.next=20,Promise.all(u.map((function(e){var t=Object(d.a)(e,2),n=t[0],r=t[1];return Object(X.h)(Object(X.c)(a._db,"tiles",n._id),Q(Object(s.a)(Object(s.a)({},n),{},{boundedTiles:n.boundedTiles.filter((function(e){return e!==r})),version:n.version+1})))})));case 20:return e.next=22,Promise.all([].concat(Object(b.a)(t.map((function(e,t){return l.find((function(t){return t._id===e.tile._id}))?Object(X.h)(Object(X.c)(a._db,"tiles",e.tile._id),Q(Object(s.a)(Object(s.a)({},e.tile),{},{title:n.title||"",url:n.url||"",owner:r,boundedTiles:[],version:e.tile.version+1}))):Promise.reject("no tile found (# ".concat(e.cellNumber,")"))}))),Object(b.a)(t.map((function(e){return Object(X.h)(Object(X.c)(a._db,"tokens",e.token._id),te(Object(s.a)(Object(s.a)({},e.token),{},{price:n.price||e.token.price})))})))));case 22:return e.next=24,this.fetchTiles();case 24:return e.abrupt("return",[!0,""]);case 27:throw e.prev=27,e.t0=e.catch(6),e.t0;case 30:case"end":return e.stop()}}),e,this,[[6,27]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"mintTiles",value:function(){var e=Object(H.a)(P.a.mark((function e(t,n){var r,c=this;return P.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("mintTiles",t),console.log("%c mint tiles ","background-color: orange; color: green",t),this.getAccount()){e.next=5;break}return e.abrupt("return",[!1,"no current account address"]);case 5:if(t.length){e.next=7;break}return e.abrupt("return",[!1,"no tiles for minting"]);case 7:return e.prev=7,e.next=10,Promise.all(t.map((function(e,t){return Object(X.a)(c._tokensCollection,te({id:e.cellNumber,_id:void 0,owner:c.getAccount()||J,price:n.price||"2.5"}))})));case 10:return r=e.sent,console.log("mint result",r),e.next=14,Promise.all(t.map((function(e,t){return Object(X.a)(c._tilesCollection,Q({id:e.cellNumber,_id:void 0,version:0,boundedTiles:[],owner:c.getAccount()||J,title:n.title||"",url:n.url||"",tokenId:e.cellNumber}))})));case 14:return e.next=16,this.fetchTiles();case 16:return e.abrupt("return",[!0,""]);case 19:throw e.prev=19,e.t0=e.catch(7),e.t0;case 22:case"end":return e.stop()}}),e,this,[[7,19]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),re=function(){var e=[x.cellWidth,x.cellHeight];console.log("%c render global app! ","border: 2px solid red; color: silver; background-color: darkblue;");var t=Object(i.useMemo)((function(){return new ne}),[]),n=Object(i.useMemo)((function(){return new O.BehaviorSubject(J)}),[]),c=Object(i.useMemo)((function(){return new O.BehaviorSubject([])}),[]),o=Object(i.useMemo)((function(){return new O.BehaviorSubject([])}),[]),u=Object(i.useRef)([]),a=Object(i.useMemo)((function(){return new v.Subject}),[]),d=Object(i.useMemo)((function(){return new v.Subject}),[]),f=Object(i.useMemo)((function(){return new v.Subject}),[]);return Object(i.useEffect)((function(){t.connect().then((function(e){var r=t.getAccount();r&&n.next(r),t.fetchTiles().then((function(e){return console.log("%c items loaded! ","color: green",Object(b.a)(e))}))})).catch((function(e){}))}),[t,n]),Object(i.useEffect)((function(){var e=c.subscribe((function(e){var t=e.filter((function(e){return e.mouseType===r.Click})).map((function(e){return e.curr})),n=[],c=Object(b.a)(t);Object(b.a)(u.current).forEach((function(e){c.find((function(t){return t.cellNumber===e.cellNumber}))||n.push(e),c=c.filter((function(t){return t.cellNumber!==e.cellNumber}))})),(c.length||n.length)&&(u.current=Object(b.a)(t),o.next(Object(b.a)(t)))}));return function(){return e.unsubscribe()}}),[c,o,u]),Object(i.useEffect)((function(){var e=a.subscribe((function(e){console.log("%c cartEvent ","border: 1px solid green",e,t.getState());var n=t.getState().getValue();if(e.type===l.Modify&&d.next({type:l.Modify,payload:n.tileCells.filter((function(e){return c.getValue().find((function(t){return t.mouseType===r.Click&&e.cellNumber===t.curr.cellNumber}))})),groupUrl:""}),e.type===l.Open&&d.next({type:l.Open,payload:c.getValue().filter((function(e){return e.mouseType===r.Click})).map((function(e){var t=n.tileCells.find((function(t){return t.cellNumber===e.curr.cellNumber}));return{cellNumber:e.curr.cellNumber,point:e.curr.point,tile:t&&t.tile,token:t&&t.token}})),groupUrl:""}),e.type===l.ShowOther)return f.next([S.DisplayAll,[]]);if(e.type===l.ShowOwn){var i=t.getAccount();console.log("my account: ",i),f.next([S.DisplayOwnCells,t.getState().getValue().tileCells.filter((function(e){return e.tile.owner===i})).map((function(e){return{mouseType:r.None,curr:{cellNumber:e.cellNumber,point:e.point},lastCell:{cellNumber:-1,point:[0,0]}}}))])}}));return function(){return e.unsubscribe()}}),[t,a,d,c,f]),Object(i.useEffect)((function(){var e=d.subscribe((function(e){if(console.log("%c cartState ","border: 1px solid blue",e),e.type===l.SaveTiles){var n=e.payload.filter((function(e){return!!e.tile&&!!e.token}));n.length&&t.groupTiles(Object(b.a)(n),e.groupUrl)}if(e.type===l.Buy){var r=e.payload.filter((function(e){return!!e.tile&&!!e.token})),c=e.params?Object(s.a)({},e.params):{};c.url=c.url||e.groupUrl,r.length?(f.next([S.DisplayAll,[]]),t.buyTiles(Object(b.a)(r),c)):(f.next([S.DisplayAll,[]]),t.mintTiles(Object(b.a)(e.payload),c))}if(e.type===l.RemoveItems){var i=e.payload.filter((function(e){return!!e.tile&&!!e.token}));f.next([S.Remove,Object(b.a)(i)])}if(e.type===l.Save){var o=e.payload.filter((function(e){return!!e.tile&&!!e.token}));f.next([S.UserUpdateTileGroup,Object(b.a)(o)])}}));return function(){return e.unsubscribe()}}),[t,f,d,c]),Object(p.jsx)("div",{id:"app-container",children:Object(p.jsxs)(y.Provider,{value:t,children:[Object(p.jsx)(m,{event$:a,selectedCells$:o}),Object(p.jsx)(R,{cellSize:e,currentAcc$:n,cellsAmount:x.cellsAmount,cellBorderWidth:x.cellBorderWidth,maxCanvasWidth:x.maxCanvasWidth||0,event$:c,cellsUpdate$:f}),Object(p.jsx)(L,{event$:d})]})})};a.a.render(Object(p.jsx)(re,{}),document.getElementById("root"))}},[[62,1,2]]]);
//# sourceMappingURL=main.649901f1.chunk.js.map